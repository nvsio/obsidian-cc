/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
Obsidian CC - The Ultimate Obsidian Companion
https://github.com/YOUR_USERNAME/obsidian-cc
*/

var di=Object.create;var Rt=Object.defineProperty;var pi=Object.getOwnPropertyDescriptor;var hi=Object.getOwnPropertyNames;var mi=Object.getPrototypeOf,fi=Object.prototype.hasOwnProperty;var gi=(s,e)=>{for(var t in e)Rt(s,t,{get:e[t],enumerable:!0})},Vr=(s,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of hi(e))!fi.call(s,r)&&r!==t&&Rt(s,r,{get:()=>e[r],enumerable:!(n=pi(e,r))||n.enumerable});return s};var qe=(s,e,t)=>(t=s!=null?di(mi(s)):{},Vr(e||!s||!s.__esModule?Rt(t,"default",{value:s,enumerable:!0}):t,s)),yi=s=>Vr(Rt({},"__esModule",{value:!0}),s);var Ia={};gi(Ia,{VIEW_TYPE_CHAT:()=>vr,default:()=>vn});module.exports=yi(Ia);var Z=require("obsidian");var Kr={agenticBackend:"sdk",model:"claude-sonnet-4-20250514",maxTokens:4096,temperature:.7,claudeCodeIntegration:!0,autoUpdateClaudeMd:!0,mcpServerEnabled:!0,mcpServerPort:3333,inlineEnabled:!0,agenticEnabled:!0,inlineTrigger:"@claude",agenticTrigger:"@cc",qmdEnabled:!0,qmdPath:"",qmdSearchScope:"vault",autoIndex:!0,searchMode:"hybrid",maxSearchResults:10,tasksIntegration:!0,taskFormat:"obsidian-tasks",defaultClonePath:"",requireApproval:!0,auditLogging:!1,debugMode:!1,customSystemPrompt:"",timeout:6e4},Xr=[{value:"claude-sonnet-4-20250514",label:"Claude Sonnet 4 (Recommended)"},{value:"claude-opus-4-20250514",label:"Claude Opus 4 (Most capable)"},{value:"claude-haiku-3-5-20241022",label:"Claude Haiku 3.5 (Fastest)"}],Qr=[{value:"obsidian-tasks",label:"Obsidian Tasks Plugin"},{value:"dataview",label:"Dataview Compatible"},{value:"basic",label:"Basic Markdown"}],Jr=[{value:"hybrid",label:"Hybrid (Best quality)"},{value:"semantic",label:"Semantic Only"},{value:"keyword",label:"Keyword Only (Fastest)"}];var $e=class $e{constructor(e){this.plugin=e}getSafeStorage(){try{let e=window.require?.("electron");return e&&(e.safeStorage||e.remote?.safeStorage)||null}catch{return null}}isSecureStorageAvailable(){return this.getSafeStorage()?.isEncryptionAvailable?.()??!1}getStorageStatus(){let e=this.getSafeStorage();if(!e)return{secure:!1,backend:"unavailable"};if(!e.isEncryptionAvailable())return{secure:!1,backend:"encryption-unavailable"};let t=process.platform;switch(t){case"darwin":return{secure:!0,backend:"macOS Keychain"};case"win32":return{secure:!0,backend:"Windows DPAPI"};case"linux":let n=e.getSelectedStorageBackend?.()||"libsecret";return{secure:n!=="basic_text",backend:n};default:return{secure:!0,backend:t}}}async storeApiKey(e){await this.storeSecurely("anthropic-api-key",e)}async getApiKey(){let e=process.env.ANTHROPIC_API_KEY;return e&&e.length>0?e:this.retrieveSecurely("anthropic-api-key")}async deleteApiKey(){await this.deleteSecurely("anthropic-api-key")}async storeGitHubToken(e){await this.storeSecurely("github-token",e)}async getGitHubToken(){let e=process.env.GITHUB_TOKEN;return e&&e.length>0?e:this.retrieveSecurely("github-token")}async deleteGitHubToken(){await this.deleteSecurely("github-token")}async storeSecurely(e,t){let n=`${$e.STORAGE_KEY_PREFIX}-${e}`,r=this.getSafeStorage();if(r&&r.isEncryptionAvailable()){let i=r.encryptString(t);await this.saveToPluginData(n,{type:"encrypted",data:i.toString("base64")})}else{console.warn("Obsidian CC: Secure storage unavailable. Using fallback storage. Consider using environment variables instead.");let i=Buffer.from(t).toString("base64");await this.saveToPluginData(n,{type:"obfuscated",data:i})}}async retrieveSecurely(e){let t=`${$e.STORAGE_KEY_PREFIX}-${e}`,n=await this.loadFromPluginData(t);if(!n)return null;let r=this.getSafeStorage();if(n.type==="encrypted"){if(!r||!r.isEncryptionAvailable())return console.error("Obsidian CC: Cannot decrypt stored value - encryption unavailable"),null;try{let i=Buffer.from(n.data,"base64");return r.decryptString(i)}catch(i){return console.error("Obsidian CC: Failed to decrypt stored value:",i),null}}else if(n.type==="obfuscated")try{return Buffer.from(n.data,"base64").toString("utf8")}catch{return null}return null}async deleteSecurely(e){let t=`${$e.STORAGE_KEY_PREFIX}-${e}`,n=await this.plugin.loadData()||{};delete n[t],await this.plugin.saveData(n)}async saveToPluginData(e,t){let n=await this.plugin.loadData()||{};n[e]=t,await this.plugin.saveData(n)}async loadFromPluginData(e){return(await this.plugin.loadData())?.[e]||null}async hasStoredCredentials(){let e=await this.getApiKey();return e!==null&&e.length>0}validateApiKeyFormat(e){return e.startsWith("sk-ant-")&&e.length>20}maskApiKey(e){return e.length<=12?"********":e.substring(0,7)+"..."+e.substring(e.length-4)}};$e.STORAGE_KEY_PREFIX="obsidian-cc";var It=$e;var{entries:as,setPrototypeOf:Yr,isFrozen:wi,getPrototypeOf:bi,getOwnPropertyDescriptor:Si}=Object,{freeze:B,seal:z,create:Vn}=Object,{apply:Kn,construct:Xn}=typeof Reflect<"u"&&Reflect;B||(B=function(e){return e});z||(z=function(e){return e});Kn||(Kn=function(e,t){for(var n=arguments.length,r=new Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return e.apply(t,r)});Xn||(Xn=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return new e(...n)});var Ot=q(Array.prototype.forEach),xi=q(Array.prototype.lastIndexOf),Zr=q(Array.prototype.pop),Ze=q(Array.prototype.push),vi=q(Array.prototype.splice),Lt=q(String.prototype.toLowerCase),Un=q(String.prototype.toString),Hn=q(String.prototype.match),et=q(String.prototype.replace),Ti=q(String.prototype.indexOf),Ci=q(String.prototype.trim),J=q(Object.prototype.hasOwnProperty),F=q(RegExp.prototype.test),tt=Ei(TypeError);function q(s){return function(e){e instanceof RegExp&&(e.lastIndex=0);for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return Kn(s,e,n)}}function Ei(s){return function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return Xn(s,t)}}function y(s,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Lt;Yr&&Yr(s,null);let n=e.length;for(;n--;){let r=e[n];if(typeof r=="string"){let i=t(r);i!==r&&(wi(e)||(e[n]=i),r=i)}s[r]=!0}return s}function _i(s){for(let e=0;e<s.length;e++)J(s,e)||(s[e]=null);return s}function re(s){let e=Vn(null);for(let[t,n]of as(s))J(s,t)&&(Array.isArray(n)?e[t]=_i(n):n&&typeof n=="object"&&n.constructor===Object?e[t]=re(n):e[t]=n);return e}function nt(s,e){for(;s!==null;){let n=Si(s,e);if(n){if(n.get)return q(n.get);if(typeof n.value=="function")return q(n.value)}s=bi(s)}function t(){return null}return t}var es=B(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dialog","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","search","section","select","shadow","slot","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),Wn=B(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","circle","clippath","defs","desc","ellipse","enterkeyhint","exportparts","filter","font","g","glyph","glyphref","hkern","image","inputmode","line","lineargradient","marker","mask","metadata","mpath","part","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","view","vkern"]),jn=B(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),Pi=B(["animate","color-profile","cursor","discard","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignobject","hatch","hatchpath","mesh","meshgradient","meshpatch","meshrow","missing-glyph","script","set","solidcolor","unknown","use"]),zn=B(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover","mprescripts"]),Ai=B(["maction","maligngroup","malignmark","mlongdiv","mscarries","mscarry","msgroup","mstack","msline","msrow","semantics","annotation","annotation-xml","mprescripts","none"]),ts=B(["#text"]),ns=B(["accept","action","align","alt","autocapitalize","autocomplete","autopictureinpicture","autoplay","background","bgcolor","border","capture","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","controls","controlslist","coords","crossorigin","datetime","decoding","default","dir","disabled","disablepictureinpicture","disableremoteplayback","download","draggable","enctype","enterkeyhint","exportparts","face","for","headers","height","hidden","high","href","hreflang","id","inert","inputmode","integrity","ismap","kind","label","lang","list","loading","loop","low","max","maxlength","media","method","min","minlength","multiple","muted","name","nonce","noshade","novalidate","nowrap","open","optimum","part","pattern","placeholder","playsinline","popover","popovertarget","popovertargetaction","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","slot","span","srclang","start","src","srcset","step","style","summary","tabindex","title","translate","type","usemap","valign","value","width","wrap","xmlns","slot"]),Gn=B(["accent-height","accumulate","additive","alignment-baseline","amplitude","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clippathunits","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","exponent","fill","fill-opacity","fill-rule","filter","filterunits","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","intercept","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","mask-type","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","primitiveunits","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","slope","specularconstant","specularexponent","spreadmethod","startoffset","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","systemlanguage","tabindex","tablevalues","targetx","targety","transform","transform-origin","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","version","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),rs=B(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","encoding","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),Dt=B(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),ki=z(/\{\{[\w\W]*|[\w\W]*\}\}/gm),Mi=z(/<%[\w\W]*|[\w\W]*%>/gm),Ri=z(/\$\{[\w\W]*/gm),Ii=z(/^data-[\-\w.\u00B7-\uFFFF]+$/),Oi=z(/^aria-[\-\w]+$/),os=z(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp|matrix):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),Di=z(/^(?:\w+script|data):/i),Li=z(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g),ls=z(/^html$/i),Ni=z(/^[a-z][.\w]*(-[.\w]+)+$/i),ss=Object.freeze({__proto__:null,ARIA_ATTR:Oi,ATTR_WHITESPACE:Li,CUSTOM_ELEMENT:Ni,DATA_ATTR:Ii,DOCTYPE_NAME:ls,ERB_EXPR:Mi,IS_ALLOWED_URI:os,IS_SCRIPT_OR_DATA:Di,MUSTACHE_EXPR:ki,TMPLIT_EXPR:Ri}),rt={element:1,attribute:2,text:3,cdataSection:4,entityReference:5,entityNode:6,progressingInstruction:7,comment:8,document:9,documentType:10,documentFragment:11,notation:12},Fi=function(){return typeof window>"u"?null:window},Bi=function(e,t){if(typeof e!="object"||typeof e.createPolicy!="function")return null;let n=null,r="data-tt-policy-suffix";t&&t.hasAttribute(r)&&(n=t.getAttribute(r));let i="dompurify"+(n?"#"+n:"");try{return e.createPolicy(i,{createHTML(o){return o},createScriptURL(o){return o}})}catch{return console.warn("TrustedTypes policy "+i+" could not be created."),null}},is=function(){return{afterSanitizeAttributes:[],afterSanitizeElements:[],afterSanitizeShadowDOM:[],beforeSanitizeAttributes:[],beforeSanitizeElements:[],beforeSanitizeShadowDOM:[],uponSanitizeAttribute:[],uponSanitizeElement:[],uponSanitizeShadowNode:[]}};function cs(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Fi(),e=h=>cs(h);if(e.version="3.3.1",e.removed=[],!s||!s.document||s.document.nodeType!==rt.document||!s.Element)return e.isSupported=!1,e;let{document:t}=s,n=t,r=n.currentScript,{DocumentFragment:i,HTMLTemplateElement:o,Node:l,Element:d,NodeFilter:u,NamedNodeMap:m=s.NamedNodeMap||s.MozNamedAttrMap,HTMLFormElement:S,DOMParser:T,trustedTypes:$}=s,O=d.prototype,Se=nt(O,"cloneNode"),j=nt(O,"remove"),Tn=nt(O,"nextSibling"),Cn=nt(O,"childNodes"),ee=nt(O,"parentNode");if(typeof o=="function"){let h=t.createElement("template");h.content&&h.content.ownerDocument&&(t=h.content.ownerDocument)}let C,xe="",{implementation:En,createNodeIterator:Xs,createDocumentFragment:Qs,getElementsByTagName:Js}=t,{importNode:Ys}=n,N=is();e.isSupported=typeof as=="function"&&typeof ee=="function"&&En&&En.createHTMLDocument!==void 0;let{MUSTACHE_EXPR:_n,ERB_EXPR:Pn,TMPLIT_EXPR:An,DATA_ATTR:Zs,ARIA_ATTR:ei,IS_SCRIPT_OR_DATA:ti,ATTR_WHITESPACE:Tr,CUSTOM_ELEMENT:ni}=ss,{IS_ALLOWED_URI:Cr}=ss,A=null,Er=y({},[...es,...Wn,...jn,...zn,...ts]),M=null,_r=y({},[...ns,...Gn,...rs,...Dt]),E=Object.seal(Vn(null,{tagNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeNameCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},allowCustomizedBuiltInElements:{writable:!0,configurable:!1,enumerable:!0,value:!1}})),Qe=null,kn=null,Ie=Object.seal(Vn(null,{tagCheck:{writable:!0,configurable:!1,enumerable:!0,value:null},attributeCheck:{writable:!0,configurable:!1,enumerable:!0,value:null}})),Pr=!0,Mn=!0,Ar=!1,kr=!0,Oe=!1,Ct=!0,ve=!1,Rn=!1,In=!1,De=!1,Et=!1,_t=!1,Mr=!0,Rr=!1,ri="user-content-",On=!0,Je=!1,Le={},te=null,Dn=y({},["annotation-xml","audio","colgroup","desc","foreignobject","head","iframe","math","mi","mn","mo","ms","mtext","noembed","noframes","noscript","plaintext","script","style","svg","template","thead","title","video","xmp"]),Ir=null,Or=y({},["audio","video","img","source","image","track"]),Ln=null,Dr=y({},["alt","class","for","id","label","name","pattern","placeholder","role","summary","title","value","style","xmlns"]),Pt="http://www.w3.org/1998/Math/MathML",At="http://www.w3.org/2000/svg",ae="http://www.w3.org/1999/xhtml",Ne=ae,Nn=!1,Fn=null,si=y({},[Pt,At,ae],Un),kt=y({},["mi","mo","mn","ms","mtext"]),Mt=y({},["annotation-xml"]),ii=y({},["title","style","font","a","script"]),Ye=null,ai=["application/xhtml+xml","text/html"],oi="text/html",P=null,Fe=null,li=t.createElement("form"),Lr=function(a){return a instanceof RegExp||a instanceof Function},Bn=function(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(!(Fe&&Fe===a)){if((!a||typeof a!="object")&&(a={}),a=re(a),Ye=ai.indexOf(a.PARSER_MEDIA_TYPE)===-1?oi:a.PARSER_MEDIA_TYPE,P=Ye==="application/xhtml+xml"?Un:Lt,A=J(a,"ALLOWED_TAGS")?y({},a.ALLOWED_TAGS,P):Er,M=J(a,"ALLOWED_ATTR")?y({},a.ALLOWED_ATTR,P):_r,Fn=J(a,"ALLOWED_NAMESPACES")?y({},a.ALLOWED_NAMESPACES,Un):si,Ln=J(a,"ADD_URI_SAFE_ATTR")?y(re(Dr),a.ADD_URI_SAFE_ATTR,P):Dr,Ir=J(a,"ADD_DATA_URI_TAGS")?y(re(Or),a.ADD_DATA_URI_TAGS,P):Or,te=J(a,"FORBID_CONTENTS")?y({},a.FORBID_CONTENTS,P):Dn,Qe=J(a,"FORBID_TAGS")?y({},a.FORBID_TAGS,P):re({}),kn=J(a,"FORBID_ATTR")?y({},a.FORBID_ATTR,P):re({}),Le=J(a,"USE_PROFILES")?a.USE_PROFILES:!1,Pr=a.ALLOW_ARIA_ATTR!==!1,Mn=a.ALLOW_DATA_ATTR!==!1,Ar=a.ALLOW_UNKNOWN_PROTOCOLS||!1,kr=a.ALLOW_SELF_CLOSE_IN_ATTR!==!1,Oe=a.SAFE_FOR_TEMPLATES||!1,Ct=a.SAFE_FOR_XML!==!1,ve=a.WHOLE_DOCUMENT||!1,De=a.RETURN_DOM||!1,Et=a.RETURN_DOM_FRAGMENT||!1,_t=a.RETURN_TRUSTED_TYPE||!1,In=a.FORCE_BODY||!1,Mr=a.SANITIZE_DOM!==!1,Rr=a.SANITIZE_NAMED_PROPS||!1,On=a.KEEP_CONTENT!==!1,Je=a.IN_PLACE||!1,Cr=a.ALLOWED_URI_REGEXP||os,Ne=a.NAMESPACE||ae,kt=a.MATHML_TEXT_INTEGRATION_POINTS||kt,Mt=a.HTML_INTEGRATION_POINTS||Mt,E=a.CUSTOM_ELEMENT_HANDLING||{},a.CUSTOM_ELEMENT_HANDLING&&Lr(a.CUSTOM_ELEMENT_HANDLING.tagNameCheck)&&(E.tagNameCheck=a.CUSTOM_ELEMENT_HANDLING.tagNameCheck),a.CUSTOM_ELEMENT_HANDLING&&Lr(a.CUSTOM_ELEMENT_HANDLING.attributeNameCheck)&&(E.attributeNameCheck=a.CUSTOM_ELEMENT_HANDLING.attributeNameCheck),a.CUSTOM_ELEMENT_HANDLING&&typeof a.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements=="boolean"&&(E.allowCustomizedBuiltInElements=a.CUSTOM_ELEMENT_HANDLING.allowCustomizedBuiltInElements),Oe&&(Mn=!1),Et&&(De=!0),Le&&(A=y({},ts),M=[],Le.html===!0&&(y(A,es),y(M,ns)),Le.svg===!0&&(y(A,Wn),y(M,Gn),y(M,Dt)),Le.svgFilters===!0&&(y(A,jn),y(M,Gn),y(M,Dt)),Le.mathMl===!0&&(y(A,zn),y(M,rs),y(M,Dt))),a.ADD_TAGS&&(typeof a.ADD_TAGS=="function"?Ie.tagCheck=a.ADD_TAGS:(A===Er&&(A=re(A)),y(A,a.ADD_TAGS,P))),a.ADD_ATTR&&(typeof a.ADD_ATTR=="function"?Ie.attributeCheck=a.ADD_ATTR:(M===_r&&(M=re(M)),y(M,a.ADD_ATTR,P))),a.ADD_URI_SAFE_ATTR&&y(Ln,a.ADD_URI_SAFE_ATTR,P),a.FORBID_CONTENTS&&(te===Dn&&(te=re(te)),y(te,a.FORBID_CONTENTS,P)),a.ADD_FORBID_CONTENTS&&(te===Dn&&(te=re(te)),y(te,a.ADD_FORBID_CONTENTS,P)),On&&(A["#text"]=!0),ve&&y(A,["html","head","body"]),A.table&&(y(A,["tbody"]),delete Qe.tbody),a.TRUSTED_TYPES_POLICY){if(typeof a.TRUSTED_TYPES_POLICY.createHTML!="function")throw tt('TRUSTED_TYPES_POLICY configuration option must provide a "createHTML" hook.');if(typeof a.TRUSTED_TYPES_POLICY.createScriptURL!="function")throw tt('TRUSTED_TYPES_POLICY configuration option must provide a "createScriptURL" hook.');C=a.TRUSTED_TYPES_POLICY,xe=C.createHTML("")}else C===void 0&&(C=Bi($,r)),C!==null&&typeof xe=="string"&&(xe=C.createHTML(""));B&&B(a),Fe=a}},Nr=y({},[...Wn,...jn,...Pi]),Fr=y({},[...zn,...Ai]),ci=function(a){let c=ee(a);(!c||!c.tagName)&&(c={namespaceURI:Ne,tagName:"template"});let p=Lt(a.tagName),v=Lt(c.tagName);return Fn[a.namespaceURI]?a.namespaceURI===At?c.namespaceURI===ae?p==="svg":c.namespaceURI===Pt?p==="svg"&&(v==="annotation-xml"||kt[v]):!!Nr[p]:a.namespaceURI===Pt?c.namespaceURI===ae?p==="math":c.namespaceURI===At?p==="math"&&Mt[v]:!!Fr[p]:a.namespaceURI===ae?c.namespaceURI===At&&!Mt[v]||c.namespaceURI===Pt&&!kt[v]?!1:!Fr[p]&&(ii[p]||!Nr[p]):!!(Ye==="application/xhtml+xml"&&Fn[a.namespaceURI]):!1},ne=function(a){Ze(e.removed,{element:a});try{ee(a).removeChild(a)}catch{j(a)}},Te=function(a,c){try{Ze(e.removed,{attribute:c.getAttributeNode(a),from:c})}catch{Ze(e.removed,{attribute:null,from:c})}if(c.removeAttribute(a),a==="is")if(De||Et)try{ne(c)}catch{}else try{c.setAttribute(a,"")}catch{}},Br=function(a){let c=null,p=null;if(In)a="<remove></remove>"+a;else{let _=Hn(a,/^[\r\n\t ]+/);p=_&&_[0]}Ye==="application/xhtml+xml"&&Ne===ae&&(a='<html xmlns="http://www.w3.org/1999/xhtml"><head></head><body>'+a+"</body></html>");let v=C?C.createHTML(a):a;if(Ne===ae)try{c=new T().parseFromString(v,Ye)}catch{}if(!c||!c.documentElement){c=En.createDocument(Ne,"template",null);try{c.documentElement.innerHTML=Nn?xe:v}catch{}}let D=c.body||c.documentElement;return a&&p&&D.insertBefore(t.createTextNode(p),D.childNodes[0]||null),Ne===ae?Js.call(c,ve?"html":"body")[0]:ve?c.documentElement:D},qr=function(a){return Xs.call(a.ownerDocument||a,a,u.SHOW_ELEMENT|u.SHOW_COMMENT|u.SHOW_TEXT|u.SHOW_PROCESSING_INSTRUCTION|u.SHOW_CDATA_SECTION,null)},qn=function(a){return a instanceof S&&(typeof a.nodeName!="string"||typeof a.textContent!="string"||typeof a.removeChild!="function"||!(a.attributes instanceof m)||typeof a.removeAttribute!="function"||typeof a.setAttribute!="function"||typeof a.namespaceURI!="string"||typeof a.insertBefore!="function"||typeof a.hasChildNodes!="function")},$r=function(a){return typeof l=="function"&&a instanceof l};function oe(h,a,c){Ot(h,p=>{p.call(e,a,c,Fe)})}let Ur=function(a){let c=null;if(oe(N.beforeSanitizeElements,a,null),qn(a))return ne(a),!0;let p=P(a.nodeName);if(oe(N.uponSanitizeElement,a,{tagName:p,allowedTags:A}),Ct&&a.hasChildNodes()&&!$r(a.firstElementChild)&&F(/<[/\w!]/g,a.innerHTML)&&F(/<[/\w!]/g,a.textContent)||a.nodeType===rt.progressingInstruction||Ct&&a.nodeType===rt.comment&&F(/<[/\w]/g,a.data))return ne(a),!0;if(!(Ie.tagCheck instanceof Function&&Ie.tagCheck(p))&&(!A[p]||Qe[p])){if(!Qe[p]&&Wr(p)&&(E.tagNameCheck instanceof RegExp&&F(E.tagNameCheck,p)||E.tagNameCheck instanceof Function&&E.tagNameCheck(p)))return!1;if(On&&!te[p]){let v=ee(a)||a.parentNode,D=Cn(a)||a.childNodes;if(D&&v){let _=D.length;for(let U=_-1;U>=0;--U){let le=Se(D[U],!0);le.__removalCount=(a.__removalCount||0)+1,v.insertBefore(le,Tn(a))}}}return ne(a),!0}return a instanceof d&&!ci(a)||(p==="noscript"||p==="noembed"||p==="noframes")&&F(/<\/no(script|embed|frames)/i,a.innerHTML)?(ne(a),!0):(Oe&&a.nodeType===rt.text&&(c=a.textContent,Ot([_n,Pn,An],v=>{c=et(c,v," ")}),a.textContent!==c&&(Ze(e.removed,{element:a.cloneNode()}),a.textContent=c)),oe(N.afterSanitizeElements,a,null),!1)},Hr=function(a,c,p){if(Mr&&(c==="id"||c==="name")&&(p in t||p in li))return!1;if(!(Mn&&!kn[c]&&F(Zs,c))){if(!(Pr&&F(ei,c))){if(!(Ie.attributeCheck instanceof Function&&Ie.attributeCheck(c,a))){if(!M[c]||kn[c]){if(!(Wr(a)&&(E.tagNameCheck instanceof RegExp&&F(E.tagNameCheck,a)||E.tagNameCheck instanceof Function&&E.tagNameCheck(a))&&(E.attributeNameCheck instanceof RegExp&&F(E.attributeNameCheck,c)||E.attributeNameCheck instanceof Function&&E.attributeNameCheck(c,a))||c==="is"&&E.allowCustomizedBuiltInElements&&(E.tagNameCheck instanceof RegExp&&F(E.tagNameCheck,p)||E.tagNameCheck instanceof Function&&E.tagNameCheck(p))))return!1}else if(!Ln[c]){if(!F(Cr,et(p,Tr,""))){if(!((c==="src"||c==="xlink:href"||c==="href")&&a!=="script"&&Ti(p,"data:")===0&&Ir[a])){if(!(Ar&&!F(ti,et(p,Tr,"")))){if(p)return!1}}}}}}}return!0},Wr=function(a){return a!=="annotation-xml"&&Hn(a,ni)},jr=function(a){oe(N.beforeSanitizeAttributes,a,null);let{attributes:c}=a;if(!c||qn(a))return;let p={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:M,forceKeepAttr:void 0},v=c.length;for(;v--;){let D=c[v],{name:_,namespaceURI:U,value:le}=D,Be=P(_),$n=le,R=_==="value"?$n:Ci($n);if(p.attrName=Be,p.attrValue=R,p.keepAttr=!0,p.forceKeepAttr=void 0,oe(N.uponSanitizeAttribute,a,p),R=p.attrValue,Rr&&(Be==="id"||Be==="name")&&(Te(_,a),R=ri+R),Ct&&F(/((--!?|])>)|<\/(style|title|textarea)/i,R)){Te(_,a);continue}if(Be==="attributename"&&Hn(R,"href")){Te(_,a);continue}if(p.forceKeepAttr)continue;if(!p.keepAttr){Te(_,a);continue}if(!kr&&F(/\/>/i,R)){Te(_,a);continue}Oe&&Ot([_n,Pn,An],Gr=>{R=et(R,Gr," ")});let zr=P(a.nodeName);if(!Hr(zr,Be,R)){Te(_,a);continue}if(C&&typeof $=="object"&&typeof $.getAttributeType=="function"&&!U)switch($.getAttributeType(zr,Be)){case"TrustedHTML":{R=C.createHTML(R);break}case"TrustedScriptURL":{R=C.createScriptURL(R);break}}if(R!==$n)try{U?a.setAttributeNS(U,_,R):a.setAttribute(_,R),qn(a)?ne(a):Zr(e.removed)}catch{Te(_,a)}}oe(N.afterSanitizeAttributes,a,null)},ui=function h(a){let c=null,p=qr(a);for(oe(N.beforeSanitizeShadowDOM,a,null);c=p.nextNode();)oe(N.uponSanitizeShadowNode,c,null),Ur(c),jr(c),c.content instanceof i&&h(c.content);oe(N.afterSanitizeShadowDOM,a,null)};return e.sanitize=function(h){let a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},c=null,p=null,v=null,D=null;if(Nn=!h,Nn&&(h="<!-->"),typeof h!="string"&&!$r(h))if(typeof h.toString=="function"){if(h=h.toString(),typeof h!="string")throw tt("dirty is not a string, aborting")}else throw tt("toString is not a function");if(!e.isSupported)return h;if(Rn||Bn(a),e.removed=[],typeof h=="string"&&(Je=!1),Je){if(h.nodeName){let le=P(h.nodeName);if(!A[le]||Qe[le])throw tt("root node is forbidden and cannot be sanitized in-place")}}else if(h instanceof l)c=Br("<!---->"),p=c.ownerDocument.importNode(h,!0),p.nodeType===rt.element&&p.nodeName==="BODY"||p.nodeName==="HTML"?c=p:c.appendChild(p);else{if(!De&&!Oe&&!ve&&h.indexOf("<")===-1)return C&&_t?C.createHTML(h):h;if(c=Br(h),!c)return De?null:_t?xe:""}c&&In&&ne(c.firstChild);let _=qr(Je?h:c);for(;v=_.nextNode();)Ur(v),jr(v),v.content instanceof i&&ui(v.content);if(Je)return h;if(De){if(Et)for(D=Qs.call(c.ownerDocument);c.firstChild;)D.appendChild(c.firstChild);else D=c;return(M.shadowroot||M.shadowrootmode)&&(D=Ys.call(n,D,!0)),D}let U=ve?c.outerHTML:c.innerHTML;return ve&&A["!doctype"]&&c.ownerDocument&&c.ownerDocument.doctype&&c.ownerDocument.doctype.name&&F(ls,c.ownerDocument.doctype.name)&&(U="<!DOCTYPE "+c.ownerDocument.doctype.name+`>
`+U),Oe&&Ot([_n,Pn,An],le=>{U=et(U,le," ")}),C&&_t?C.createHTML(U):U},e.setConfig=function(){let h=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};Bn(h),Rn=!0},e.clearConfig=function(){Fe=null,Rn=!1},e.isValidAttribute=function(h,a,c){Fe||Bn({});let p=P(h),v=P(a);return Hr(p,v,c)},e.addHook=function(h,a){typeof a=="function"&&Ze(N[h],a)},e.removeHook=function(h,a){if(a!==void 0){let c=xi(N[h],a);return c===-1?void 0:vi(N[h],c,1)[0]}return Zr(N[h])},e.removeHooks=function(h){N[h]=[]},e.removeAllHooks=function(){N=is()},e}var Qn=cs();var Jn=require("obsidian"),Nt=class{constructor(){this.purifyConfig={ALLOWED_TAGS:["p","br","strong","b","em","i","u","s","del","code","pre","kbd","samp","ul","ol","li","blockquote","hr","a","h1","h2","h3","h4","h5","h6","table","thead","tbody","tr","th","td","img","span","div","sup","sub","details","summary"],ALLOWED_ATTR:["href","src","alt","title","class","id","colspan","rowspan","data-href"],ALLOW_DATA_ATTR:!1,USE_PROFILES:{html:!0},ALLOWED_URI_REGEXP:/^(?:(?:https?|mailto|obsidian):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i,FORBID_TAGS:["svg","math","script","style","iframe","object","embed","form","input","button"],FORBID_ATTR:["onerror","onload","onclick","onmouseover","onfocus","onblur"]}}sanitizeHTML(e){return Qn.sanitize(e,this.purifyConfig)}sanitizeMarkdown(e){return e.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"").replace(/javascript:/gi,"blocked:").replace(/data:(?!image\/(png|jpeg|gif|webp);base64,)/gi,"blocked:").replace(/\s+on\w+\s*=/gi," data-blocked=").replace(/vbscript:/gi,"blocked:")}validateFilePath(e){if(!e||typeof e!="string"||(0,Jn.normalizePath)(e).includes("..")||e.startsWith("/")||/^[A-Za-z]:/.test(e)||e.includes("\0"))return!1;let n=[/\.\./,/^~\//,/^\$/,/%2e%2e/i,/%252e%252e/i];for(let r of n)if(r.test(e))return!1;return!0}sanitizeFilePath(e){if(!this.validateFilePath(e))return null;let t=(0,Jn.normalizePath)(e);return t=t.replace(/^\/+/,""),t=t.replace(/\x00/g,""),t}sanitizePrompt(e){return!e||typeof e!="string"?"":e.replace(/\x00/g,"").replace(/[\r\n]+/g,`
`).replace(/\n{3,}/g,`

`).trim()}sanitizeURL(e){if(!e||typeof e!="string")return null;try{let t=new URL(e);if(!["https:","http:","obsidian:","mailto:"].includes(t.protocol))return null;let r=t.hostname.toLowerCase();if(!(r==="localhost"||r==="127.0.0.1")){let o=[/^10\./,/^172\.(1[6-9]|2[0-9]|3[0-1])\./,/^192\.168\./,/^169\.254\./,/^127\./];for(let l of o)if(l.test(r))return null}return t.toString()}catch{return null}}isAllowedHost(e,t){try{let n=new URL(e);return t.includes(n.hostname)}catch{return!1}}escapeHTML(e){let t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"};return e.replace(/[&<>"'/]/g,n=>t[n])}stripHTML(e){return Qn.sanitize(e,{ALLOWED_TAGS:[]})}};var Ce="0.32.1";var us=!1,Ee,Yn,qi,$i,Ui,ds,Hi,Ft,Zn,ps,er,Bt,hs;function ms(s,e={auto:!1}){if(us)throw new Error(`you must \`import '@anthropic-ai/sdk/shims/${s.kind}'\` before importing anything else from @anthropic-ai/sdk`);if(Ee)throw new Error(`can't \`import '@anthropic-ai/sdk/shims/${s.kind}'\` after \`import '@anthropic-ai/sdk/shims/${Ee}'\``);us=e.auto,Ee=s.kind,Yn=s.fetch,qi=s.Request,$i=s.Response,Ui=s.Headers,ds=s.FormData,Hi=s.Blob,Ft=s.File,Zn=s.ReadableStream,ps=s.getMultipartRequestOptions,er=s.getDefaultAgent,Bt=s.fileFromPath,hs=s.isFsReadStream}var qt=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function fs({manuallyImported:s}={}){let e=s?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from '@anthropic-ai/sdk'`:\n- `import '@anthropic-ai/sdk/shims/node'` (if you're running on Node)\n- `import '@anthropic-ai/sdk/shims/web'` (otherwise)\n",t,n,r,i;try{t=fetch,n=Request,r=Response,i=Headers}catch(o){throw new Error(`this environment is missing the following Web Fetch API type: ${o.message}. ${e}`)}return{kind:"web",fetch:t,Request:n,Response:r,Headers:i,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(o,l)=>({...l,body:new qt(o)}),getDefaultAgent:o=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/anthropics/anthropic-sdk-typescript#file-uploads")},isFsReadStream:o=>!1}}Ee||ms(fs(),{auto:!0});var f=class extends Error{},k=class s extends f{constructor(e,t,n,r){super(`${s.makeMessage(e,t,n)}`),this.status=e,this.headers=r,this.request_id=r?.["request-id"],this.error=t}static makeMessage(e,t,n){let r=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&r?`${e} ${r}`:e?`${e} status code (no body)`:r||"(no status code or body)"}static generate(e,t,n,r){if(!e)return new me({message:n,cause:$t(t)});let i=t;return e===400?new st(e,i,n,r):e===401?new it(e,i,n,r):e===403?new at(e,i,n,r):e===404?new ot(e,i,n,r):e===409?new lt(e,i,n,r):e===422?new ct(e,i,n,r):e===429?new ut(e,i,n,r):e>=500?new dt(e,i,n,r):new s(e,i,n,r)}},I=class extends k{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}},me=class extends k{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,t&&(this.cause=t)}},Ue=class extends me{constructor({message:e}={}){super({message:e??"Request timed out."})}},st=class extends k{constructor(){super(...arguments),this.status=400}},it=class extends k{constructor(){super(...arguments),this.status=401}},at=class extends k{constructor(){super(...arguments),this.status=403}},ot=class extends k{constructor(){super(...arguments),this.status=404}},lt=class extends k{constructor(){super(...arguments),this.status=409}},ct=class extends k{constructor(){super(...arguments),this.status=422}},ut=class extends k{constructor(){super(...arguments),this.status=429}},dt=class extends k{};var ce=class s{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];let n=s.NEWLINE_CHARS.has(t[t.length-1]||""),r=t.split(s.NEWLINE_REGEXP);return n&&r.pop(),r.length===1&&!n?(this.buffer.push(r[0]),[]):(this.buffer.length>0&&(r=[this.buffer.join("")+r[0],...r.slice(1)],this.buffer=[]),n||(this.buffer=[r.pop()||""]),r)}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new f(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new f(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new f("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];let e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}};ce.NEWLINE_CHARS=new Set([`
`,"\r"]);ce.NEWLINE_REGEXP=/\r\n|[\n\r]/g;var se=class s{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;async function*r(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let i=!1;try{for await(let o of zi(e,t)){if(o.event==="completion")try{yield JSON.parse(o.data)}catch(l){throw console.error("Could not parse message into JSON:",o.data),console.error("From chunk:",o.raw),l}if(o.event==="message_start"||o.event==="message_delta"||o.event==="message_stop"||o.event==="content_block_start"||o.event==="content_block_delta"||o.event==="content_block_stop")try{yield JSON.parse(o.data)}catch(l){throw console.error("Could not parse message into JSON:",o.data),console.error("From chunk:",o.raw),l}if(o.event!=="ping"&&o.event==="error")throw k.generate(void 0,`SSE Error: ${o.data}`,o.data,nr(e.headers))}i=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{i||t.abort()}}return new s(r,t)}static fromReadableStream(e,t){let n=!1;async function*r(){let o=new ce,l=Ut(e);for await(let d of l)for(let u of o.decode(d))yield u;for(let d of o.flush())yield d}async function*i(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let o=!1;try{for await(let l of r())o||l&&(yield JSON.parse(l));o=!0}catch(l){if(l instanceof Error&&l.name==="AbortError")return;throw l}finally{o||t.abort()}}return new s(i,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],t=[],n=this.iterator(),r=i=>({next:()=>{if(i.length===0){let o=n.next();e.push(o),t.push(o)}return i.shift()}});return[new s(()=>r(e),this.controller),new s(()=>r(t),this.controller)]}toReadableStream(){let e=this,t,n=new TextEncoder;return new Zn({async start(){t=e[Symbol.asyncIterator]()},async pull(r){try{let{value:i,done:o}=await t.next();if(o)return r.close();let l=n.encode(JSON.stringify(i)+`
`);r.enqueue(l)}catch(i){r.error(i)}},async cancel(){await t.return?.()}})}};async function*zi(s,e){if(!s.body)throw e.abort(),new f("Attempted to iterate over a response with no body");let t=new tr,n=new ce,r=Ut(s.body);for await(let i of Gi(r))for(let o of n.decode(i)){let l=t.decode(o);l&&(yield l)}for(let i of n.flush()){let o=t.decode(i);o&&(yield o)}}async function*Gi(s){let e=new Uint8Array;for await(let t of s){if(t==null)continue;let n=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t,r=new Uint8Array(e.length+n.length);r.set(e),r.set(n,e.length),e=r;let i;for(;(i=Vi(e))!==-1;)yield e.slice(0,i),e=e.slice(i)}e.length>0&&(yield e)}function Vi(s){for(let n=0;n<s.length-2;n++){if(s[n]===10&&s[n+1]===10||s[n]===13&&s[n+1]===13)return n+2;if(s[n]===13&&s[n+1]===10&&n+3<s.length&&s[n+2]===13&&s[n+3]===10)return n+4}return-1}var tr=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,r]=Ki(e,":");return r.startsWith(" ")&&(r=r.substring(1)),t==="event"?this.event=r:t==="data"&&this.data.push(r),null}};function Ki(s,e){let t=s.indexOf(e);return t!==-1?[s.substring(0,t),e,s.substring(t+e.length)]:[s,"",""]}function Ut(s){if(s[Symbol.asyncIterator])return s;let e=s.getReader();return{async next(){try{let t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}var Xi=s=>s!=null&&typeof s=="object"&&typeof s.url=="string"&&typeof s.blob=="function",Qi=s=>s!=null&&typeof s=="object"&&typeof s.name=="string"&&typeof s.lastModified=="number"&&pt(s),pt=s=>s!=null&&typeof s=="object"&&typeof s.size=="number"&&typeof s.type=="string"&&typeof s.text=="function"&&typeof s.slice=="function"&&typeof s.arrayBuffer=="function";async function gs(s,e,t){if(s=await s,Qi(s))return s;if(Xi(s)){let r=await s.blob();e||(e=new URL(s.url).pathname.split(/[\\/]/).pop()??"unknown_file");let i=pt(r)?[await r.arrayBuffer()]:[r];return new Ft(i,e,t)}let n=await Ji(s);if(e||(e=Zi(s)??"unknown_file"),!t?.type){let r=n[0]?.type;typeof r=="string"&&(t={...t,type:r})}return new Ft(n,e,t)}async function Ji(s){let e=[];if(typeof s=="string"||ArrayBuffer.isView(s)||s instanceof ArrayBuffer)e.push(s);else if(pt(s))e.push(await s.arrayBuffer());else if(ea(s))for await(let t of s)e.push(t);else throw new Error(`Unexpected data type: ${typeof s}; constructor: ${s?.constructor?.name}; props: ${Yi(s)}`);return e}function Yi(s){return`[${Object.getOwnPropertyNames(s).map(t=>`"${t}"`).join(", ")}]`}function Zi(s){return rr(s.name)||rr(s.filename)||rr(s.path)?.split(/[\\/]/).pop()}var rr=s=>{if(typeof s=="string")return s;if(typeof Buffer<"u"&&s instanceof Buffer)return String(s)},ea=s=>s!=null&&typeof s=="object"&&typeof s[Symbol.asyncIterator]=="function",sr=s=>s&&typeof s=="object"&&s.body&&s[Symbol.toStringTag]==="MultipartBody";var na=function(s,e,t,n,r){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!r:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?r.call(s,t):r?r.value=t:e.set(s,t),t},ra=function(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},Ht;async function vs(s){let{response:e}=s;if(s.options.stream)return He("response",e.status,e.url,e.headers,e.body),s.options.__streamClass?s.options.__streamClass.fromSSEResponse(e,s.controller):se.fromSSEResponse(e,s.controller);if(e.status===204)return null;if(s.options.__binaryResponse)return e;let t=e.headers.get("content-type");if(t?.includes("application/json")||t?.includes("application/vnd.api+json")){let i=await e.json();return He("response",e.status,e.url,e.headers,i),i}let r=await e.text();return He("response",e.status,e.url,e.headers,r),r}var Wt=class s extends Promise{constructor(e,t=vs){super(n=>{n(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new s(this.responsePromise,async t=>e(await this.parseResponse(t),t))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},jt=class{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e5,httpAgent:r,fetch:i}){this.baseURL=e,this.maxRetries=ir("maxRetries",t),this.timeout=ir("timeout",n),this.httpAgent=r,this.fetch=i??Yn}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...oa(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${pa()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then(async r=>{let i=r&&pt(r?.body)?new DataView(await r.body.arrayBuffer()):r?.body instanceof DataView?r.body:r?.body instanceof ArrayBuffer?new DataView(r.body):r&&ArrayBuffer.isView(r?.body)?new DataView(r.body.buffer):r?.body;return{method:e,path:t,...r,body:i}}))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){let{method:n,path:r,query:i,headers:o={}}=e,l=ArrayBuffer.isView(e.body)||e.__binaryRequest&&typeof e.body=="string"?e.body:sr(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,d=this.calculateContentLength(l),u=this.buildURL(r,i);"timeout"in e&&ir("timeout",e.timeout);let m=e.timeout??this.timeout,S=e.httpAgent??this.httpAgent??er(u),T=m+1e3;typeof S?.options?.timeout=="number"&&T>(S.options.timeout??0)&&(S.options.timeout=T),this.idempotencyHeader&&n!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),o[this.idempotencyHeader]=e.idempotencyKey);let $=this.buildHeaders({options:e,headers:o,contentLength:d,retryCount:t});return{req:{method:n,...l&&{body:l},headers:$,...S&&{agent:S},signal:e.signal??null},url:u,timeout:m}}buildHeaders({options:e,headers:t,contentLength:n,retryCount:r}){let i={};n&&(i["content-length"]=n);let o=this.defaultHeaders(e);return Ss(i,o),Ss(i,t),sr(e.body)&&Ee!=="node"&&delete i["content-type"],xs(o,"x-stainless-retry-count")===void 0&&xs(t,"x-stainless-retry-count")===void 0&&(i["x-stainless-retry-count"]=String(r)),this.validateHeaders(i,t),i}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,n,r){return k.generate(e,t,n,r)}request(e,t=null){return new Wt(this.makeRequest(e,t))}async makeRequest(e,t){let n=await e,r=n.maxRetries??this.maxRetries;t==null&&(t=r),await this.prepareOptions(n);let{req:i,url:o,timeout:l}=this.buildRequest(n,{retryCount:r-t});if(await this.prepareRequest(i,{url:o,options:n}),He("request",o,n,i.headers),n.signal?.aborted)throw new I;let d=new AbortController,u=await this.fetchWithTimeout(o,i,l,d).catch($t);if(u instanceof Error){if(n.signal?.aborted)throw new I;if(t)return this.retryRequest(n,t);throw u.name==="AbortError"?new Ue:new me({cause:u})}let m=nr(u.headers);if(!u.ok){if(t&&this.shouldRetry(u)){let j=`retrying, ${t} attempts remaining`;return He(`response (error; ${j})`,u.status,o,m),this.retryRequest(n,t,m)}let S=await u.text().catch(j=>$t(j).message),T=la(S),$=T?void 0:S;throw He(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,u.status,o,m,$),this.makeStatusError(u.status,T,$,m)}return{response:u,options:n,controller:d}}requestAPIList(e,t){let n=this.makeRequest(t,null);return new ar(this,n,e)}buildURL(e,t){let n=ua(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),r=this.defaultQuery();return mt(r)||(t={...r,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,n])=>typeof n<"u").map(([t,n])=>{if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(n)}`;if(n===null)return`${encodeURIComponent(t)}=`;throw new f(`Cannot stringify type ${typeof n}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,n,r){let{signal:i,...o}=t||{};i&&i.addEventListener("abort",()=>r.abort());let l=setTimeout(()=>r.abort(),n);return this.getRequestClient().fetch.call(void 0,e,{signal:r.signal,...o}).finally(()=>{clearTimeout(l)})}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,n){let r,i=n?.["retry-after-ms"];if(i){let l=parseFloat(i);Number.isNaN(l)||(r=l)}let o=n?.["retry-after"];if(o&&!r){let l=parseFloat(o);Number.isNaN(l)?r=Date.parse(o)-Date.now():r=l*1e3}if(!(r&&0<=r&&r<60*1e3)){let l=e.maxRetries??this.maxRetries;r=this.calculateDefaultRetryTimeoutMillis(t,l)}return await da(r),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){let i=t-e,o=Math.min(.5*Math.pow(2,i),8),l=1-Math.random()*.25;return o*l*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Ce}`}},zt=class{constructor(e,t,n,r){Ht.set(this,void 0),na(this,Ht,e,"f"),this.options=r,this.response=t,this.body=n}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){let e=this.nextPageInfo();if(!e)throw new f("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");let t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){let n=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(let[r,i]of n)e.url.searchParams.set(r,i);t.query=void 0,t.path=e.url.toString()}return await ra(this,Ht,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Ht=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},ar=class extends Wt{constructor(e,t,n){super(t,async r=>new n(e,r.response,await vs(r),r.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},nr=s=>new Proxy(Object.fromEntries(s.entries()),{get(e,t){let n=t.toString();return e[n.toLowerCase()]||e[n]}}),sa={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},ht=s=>typeof s=="object"&&s!==null&&!mt(s)&&Object.keys(s).every(e=>Ts(sa,e)),ia=()=>{if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ce,"X-Stainless-OS":ws(Deno.build.os),"X-Stainless-Arch":ys(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ce,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ce,"X-Stainless-OS":ws(process.platform),"X-Stainless-Arch":ys(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};let s=aa();return s?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ce,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${s.browser}`,"X-Stainless-Runtime-Version":s.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ce,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function aa(){if(typeof navigator>"u"||!navigator)return null;let s=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of s){let n=t.exec(navigator.userAgent);if(n){let r=n[1]||0,i=n[2]||0,o=n[3]||0;return{browser:e,version:`${r}.${i}.${o}`}}}return null}var ys=s=>s==="x32"?"x32":s==="x86_64"||s==="x64"?"x64":s==="arm"?"arm":s==="aarch64"||s==="arm64"?"arm64":s?`other:${s}`:"unknown",ws=s=>(s=s.toLowerCase(),s.includes("ios")?"iOS":s==="android"?"Android":s==="darwin"?"MacOS":s==="win32"?"Windows":s==="freebsd"?"FreeBSD":s==="openbsd"?"OpenBSD":s==="linux"?"Linux":s?`Other:${s}`:"Unknown"),bs,oa=()=>bs??(bs=ia()),la=s=>{try{return JSON.parse(s)}catch{return}},ca=new RegExp("^(?:[a-z]+:)?//","i"),ua=s=>ca.test(s),da=s=>new Promise(e=>setTimeout(e,s)),ir=(s,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new f(`${s} must be an integer`);if(e<0)throw new f(`${s} must be a positive integer`);return e},$t=s=>{if(s instanceof Error)return s;if(typeof s=="object"&&s!==null)try{return new Error(JSON.stringify(s))}catch{}return new Error(String(s))};var Gt=s=>{if(typeof process<"u")return process.env?.[s]?.trim()??void 0;if(typeof Deno<"u")return Deno.env?.get?.(s)?.trim()};function mt(s){if(!s)return!0;for(let e in s)return!1;return!0}function Ts(s,e){return Object.prototype.hasOwnProperty.call(s,e)}function Ss(s,e){for(let t in e){if(!Ts(e,t))continue;let n=t.toLowerCase();if(!n)continue;let r=e[t];r===null?delete s[n]:r!==void 0&&(s[n]=r)}}function He(s,...e){typeof process<"u"&&process?.env?.DEBUG==="true"&&console.log(`Anthropic:DEBUG:${s}`,...e)}var pa=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{let e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)}),Cs=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",ha=s=>typeof s?.get=="function";var xs=(s,e)=>{let t=e.toLowerCase();if(ha(s)){let n=e[0]?.toUpperCase()+e.substring(1).replace(/([^\w])(\w)/g,(r,i,o)=>i+o.toUpperCase());for(let r of[e,t,e.toUpperCase(),n]){let i=s.get(r);if(i)return i}}for(let[n,r]of Object.entries(s))if(n.toLowerCase()===t)return Array.isArray(r)?(r.length<=1||console.warn(`Received ${r.length} entries for the ${e} header, using the first entry.`),r[0]):r};var Vt=class extends zt{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[],this.has_more=n.has_more||!1,this.first_id=n.first_id||null,this.last_id=n.last_id||null}getPaginatedItems(){return this.data??[]}nextPageParams(){let e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;let t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){if(this.options.query?.before_id){let t=this.first_id;return t?{params:{before_id:t}}:null}let e=this.last_id;return e?{params:{after_id:e}}:null}};var L=class{constructor(e){this._client=e}};var Kt=class s{constructor(e,t){this.iterator=e,this.controller=t}async*decoder(){let e=new ce;for await(let t of this.iterator)for(let n of e.decode(t))yield JSON.parse(n);for(let t of e.flush())yield JSON.parse(t)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(e,t){if(!e.body)throw t.abort(),new f("Attempted to iterate over a response with no body");return new s(Ut(e.body),t)}};var _e=class extends L{create(e,t){let{betas:n,...r}=e;return this._client.post("/v1/messages/batches?beta=true",{body:r,...t,headers:{"anthropic-beta":[...n??[],"message-batches-2024-09-24"].toString(),...t?.headers}})}retrieve(e,t={},n){if(ht(t))return this.retrieve(e,{},t);let{betas:r}=t;return this._client.get(`/v1/messages/batches/${e}?beta=true`,{...n,headers:{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString(),...n?.headers}})}list(e={},t){if(ht(e))return this.list({},e);let{betas:n,...r}=e;return this._client.getAPIList("/v1/messages/batches?beta=true",We,{query:r,...t,headers:{"anthropic-beta":[...n??[],"message-batches-2024-09-24"].toString(),...t?.headers}})}cancel(e,t={},n){if(ht(t))return this.cancel(e,{},t);let{betas:r}=t;return this._client.post(`/v1/messages/batches/${e}/cancel?beta=true`,{...n,headers:{"anthropic-beta":[...r??[],"message-batches-2024-09-24"].toString(),...n?.headers}})}async results(e,t={},n){if(ht(t))return this.results(e,{},t);let r=await this.retrieve(e);if(!r.results_url)throw new f(`No batch \`results_url\`; Has it finished processing? ${r.processing_status} - ${r.id}`);let{betas:i}=t;return this._client.get(r.results_url,{...n,headers:{"anthropic-beta":[...i??[],"message-batches-2024-09-24"].toString(),...n?.headers},__binaryResponse:!0})._thenUnwrap((o,l)=>Kt.fromResponse(l.response,l.controller))}},We=class extends Vt{};_e.BetaMessageBatchesPage=We;var fe=class extends L{constructor(){super(...arguments),this.batches=new _e(this._client)}create(e,t){let{betas:n,...r}=e;return this._client.post("/v1/messages?beta=true",{body:r,timeout:this._client._options.timeout??6e5,...t,headers:{...n?.toString()!=null?{"anthropic-beta":n?.toString()}:void 0,...t?.headers},stream:e.stream??!1})}countTokens(e,t){let{betas:n,...r}=e;return this._client.post("/v1/messages/count_tokens?beta=true",{body:r,...t,headers:{"anthropic-beta":[...n??[],"token-counting-2024-11-01"].toString(),...t?.headers}})}};fe.Batches=_e;fe.BetaMessageBatchesPage=We;var ya=s=>{let e=0,t=[];for(;e<s.length;){let n=s[e];if(n==="\\"){e++;continue}if(n==="{"){t.push({type:"brace",value:"{"}),e++;continue}if(n==="}"){t.push({type:"brace",value:"}"}),e++;continue}if(n==="["){t.push({type:"paren",value:"["}),e++;continue}if(n==="]"){t.push({type:"paren",value:"]"}),e++;continue}if(n===":"){t.push({type:"separator",value:":"}),e++;continue}if(n===","){t.push({type:"delimiter",value:","}),e++;continue}if(n==='"'){let l="",d=!1;for(n=s[++e];n!=='"';){if(e===s.length){d=!0;break}if(n==="\\"){if(e++,e===s.length){d=!0;break}l+=n+s[e],n=s[++e]}else l+=n,n=s[++e]}n=s[++e],d||t.push({type:"string",value:l});continue}if(n&&/\s/.test(n)){e++;continue}let i=/[0-9]/;if(n&&i.test(n)||n==="-"||n==="."){let l="";for(n==="-"&&(l+=n,n=s[++e]);n&&i.test(n)||n===".";)l+=n,n=s[++e];t.push({type:"number",value:l});continue}let o=/[a-z]/i;if(n&&o.test(n)){let l="";for(;n&&o.test(n)&&e!==s.length;)l+=n,n=s[++e];if(l=="true"||l=="false"||l==="null")t.push({type:"name",value:l});else{e++;continue}continue}e++}return t},je=s=>{if(s.length===0)return s;let e=s[s.length-1];switch(e.type){case"separator":return s=s.slice(0,s.length-1),je(s);break;case"number":let t=e.value[e.value.length-1];if(t==="."||t==="-")return s=s.slice(0,s.length-1),je(s);case"string":let n=s[s.length-2];if(n?.type==="delimiter")return s=s.slice(0,s.length-1),je(s);if(n?.type==="brace"&&n.value==="{")return s=s.slice(0,s.length-1),je(s);break;case"delimiter":return s=s.slice(0,s.length-1),je(s);break}return s},wa=s=>{let e=[];return s.map(t=>{t.type==="brace"&&(t.value==="{"?e.push("}"):e.splice(e.lastIndexOf("}"),1)),t.type==="paren"&&(t.value==="["?e.push("]"):e.splice(e.lastIndexOf("]"),1))}),e.length>0&&e.reverse().map(t=>{t==="}"?s.push({type:"brace",value:"}"}):t==="]"&&s.push({type:"paren",value:"]"})}),s},ba=s=>{let e="";return s.map(t=>{switch(t.type){case"string":e+='"'+t.value+'"';break;default:e+=t.value;break}}),e},Xt=s=>JSON.parse(ba(wa(je(ya(s)))));var H=function(s,e,t,n,r){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!r:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?r.call(s,t):r?r.value=t:e.set(s,t),t},w=function(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},G,ge,Qt,Jt,ft,gt,Yt,yt,ue,wt,Zt,en,ze,or,Es,lr,cr,ur,dr,_s,Ps="__json_buf",tn=class s{constructor(){G.add(this),this.messages=[],this.receivedMessages=[],ge.set(this,void 0),this.controller=new AbortController,Qt.set(this,void 0),Jt.set(this,()=>{}),ft.set(this,()=>{}),gt.set(this,void 0),Yt.set(this,()=>{}),yt.set(this,()=>{}),ue.set(this,{}),wt.set(this,!1),Zt.set(this,!1),en.set(this,!1),ze.set(this,!1),lr.set(this,e=>{if(H(this,Zt,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new I),e instanceof I)return H(this,en,!0,"f"),this._emit("abort",e);if(e instanceof f)return this._emit("error",e);if(e instanceof Error){let t=new f(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new f(String(e)))}),H(this,Qt,new Promise((e,t)=>{H(this,Jt,e,"f"),H(this,ft,t,"f")}),"f"),H(this,gt,new Promise((e,t)=>{H(this,Yt,e,"f"),H(this,yt,t,"f")}),"f"),w(this,Qt,"f").catch(()=>{}),w(this,gt,"f").catch(()=>{})}static fromReadableStream(e){let t=new s;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,n){let r=new s;for(let i of t.messages)r._addPromptCachingBetaMessageParam(i);return r._run(()=>r._createPromptCachingBetaMessage(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),r}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},w(this,lr,"f"))}_addPromptCachingBetaMessageParam(e){this.messages.push(e)}_addPromptCachingBetaMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createPromptCachingBetaMessage(e,t,n){let r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),w(this,G,"m",cr).call(this);let i=await e.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(let o of i)w(this,G,"m",ur).call(this,o);if(i.controller.signal?.aborted)throw new I;w(this,G,"m",dr).call(this)}_connected(){this.ended||(w(this,Jt,"f").call(this),this._emit("connect"))}get ended(){return w(this,wt,"f")}get errored(){return w(this,Zt,"f")}get aborted(){return w(this,en,"f")}abort(){this.controller.abort()}on(e,t){return(w(this,ue,"f")[e]||(w(this,ue,"f")[e]=[])).push({listener:t}),this}off(e,t){let n=w(this,ue,"f")[e];if(!n)return this;let r=n.findIndex(i=>i.listener===t);return r>=0&&n.splice(r,1),this}once(e,t){return(w(this,ue,"f")[e]||(w(this,ue,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,n)=>{H(this,ze,!0,"f"),e!=="error"&&this.once("error",n),this.once(e,t)})}async done(){H(this,ze,!0,"f"),await w(this,gt,"f")}get currentMessage(){return w(this,ge,"f")}async finalMessage(){return await this.done(),w(this,G,"m",or).call(this)}async finalText(){return await this.done(),w(this,G,"m",Es).call(this)}_emit(e,...t){if(w(this,wt,"f"))return;e==="end"&&(H(this,wt,!0,"f"),w(this,Yt,"f").call(this));let n=w(this,ue,"f")[e];if(n&&(w(this,ue,"f")[e]=n.filter(r=>!r.once),n.forEach(({listener:r})=>r(...t))),e==="abort"){let r=t[0];!w(this,ze,"f")&&!n?.length&&Promise.reject(r),w(this,ft,"f").call(this,r),w(this,yt,"f").call(this,r),this._emit("end");return}if(e==="error"){let r=t[0];!w(this,ze,"f")&&!n?.length&&Promise.reject(r),w(this,ft,"f").call(this,r),w(this,yt,"f").call(this,r),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalPromptCachingBetaMessage",w(this,G,"m",or).call(this))}async _fromReadableStream(e,t){let n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),w(this,G,"m",cr).call(this),this._connected();let r=se.fromReadableStream(e,this.controller);for await(let i of r)w(this,G,"m",ur).call(this,i);if(r.controller.signal?.aborted)throw new I;w(this,G,"m",dr).call(this)}[(ge=new WeakMap,Qt=new WeakMap,Jt=new WeakMap,ft=new WeakMap,gt=new WeakMap,Yt=new WeakMap,yt=new WeakMap,ue=new WeakMap,wt=new WeakMap,Zt=new WeakMap,en=new WeakMap,ze=new WeakMap,lr=new WeakMap,G=new WeakSet,or=function(){if(this.receivedMessages.length===0)throw new f("stream ended without producing a PromptCachingBetaMessage with role=assistant");return this.receivedMessages.at(-1)},Es=function(){if(this.receivedMessages.length===0)throw new f("stream ended without producing a PromptCachingBetaMessage with role=assistant");let t=this.receivedMessages.at(-1).content.filter(n=>n.type==="text").map(n=>n.text);if(t.length===0)throw new f("stream ended without producing a content block with type=text");return t.join(" ")},cr=function(){this.ended||H(this,ge,void 0,"f")},ur=function(t){if(this.ended)return;let n=w(this,G,"m",_s).call(this,t);switch(this._emit("streamEvent",t,n),t.type){case"content_block_delta":{let r=n.content.at(-1);t.delta.type==="text_delta"&&r.type==="text"?this._emit("text",t.delta.text,r.text||""):t.delta.type==="input_json_delta"&&r.type==="tool_use"&&r.input&&this._emit("inputJson",t.delta.partial_json,r.input);break}case"message_stop":{this._addPromptCachingBetaMessageParam(n),this._addPromptCachingBetaMessage(n,!0);break}case"content_block_stop":{this._emit("contentBlock",n.content.at(-1));break}case"message_start":{H(this,ge,n,"f");break}case"content_block_start":case"message_delta":break}},dr=function(){if(this.ended)throw new f("stream has ended, this shouldn't happen");let t=w(this,ge,"f");if(!t)throw new f("request ended without sending any chunks");return H(this,ge,void 0,"f"),t},_s=function(t){let n=w(this,ge,"f");if(t.type==="message_start"){if(n)throw new f(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!n)throw new f(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return n;case"message_delta":return n.stop_reason=t.delta.stop_reason,n.stop_sequence=t.delta.stop_sequence,n.usage.output_tokens=t.usage.output_tokens,n;case"content_block_start":return n.content.push(t.content_block),n;case"content_block_delta":{let r=n.content.at(t.index);if(r?.type==="text"&&t.delta.type==="text_delta")r.text+=t.delta.text;else if(r?.type==="tool_use"&&t.delta.type==="input_json_delta"){let i=r[Ps]||"";i+=t.delta.partial_json,Object.defineProperty(r,Ps,{value:i,enumerable:!1,writable:!0}),i&&(r.input=Xt(i))}return n}case"content_block_stop":return n}},Symbol.asyncIterator)](){let e=[],t=[],n=!1;return this.on("streamEvent",r=>{let i=t.shift();i?i.resolve(r):e.push(r)}),this.on("end",()=>{n=!0;for(let r of t)r.resolve(void 0);t.length=0}),this.on("abort",r=>{n=!0;for(let i of t)i.reject(r);t.length=0}),this.on("error",r=>{n=!0;for(let i of t)i.reject(r);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((i,o)=>t.push({resolve:i,reject:o})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new se(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};var Ge=class extends L{create(e,t){let{betas:n,...r}=e;return this._client.post("/v1/messages?beta=prompt_caching",{body:r,timeout:this._client._options.timeout??6e5,...t,headers:{"anthropic-beta":[...n??[],"prompt-caching-2024-07-31"].toString(),...t?.headers},stream:e.stream??!1})}stream(e,t){return tn.createMessage(this,e,t)}};var Pe=class extends L{constructor(){super(...arguments),this.messages=new Ge(this._client)}};Pe.Messages=Ge;var de=class extends L{constructor(){super(...arguments),this.messages=new fe(this._client),this.promptCaching=new Pe(this._client)}};de.Messages=fe;de.PromptCaching=Pe;var Ae=class extends L{create(e,t){return this._client.post("/v1/complete",{body:e,timeout:this._client._options.timeout??6e5,...t,stream:e.stream??!1})}};var W=function(s,e,t,n,r){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?s!==e||!r:!e.has(s))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?r.call(s,t):r?r.value=t:e.set(s,t),t},b=function(s,e,t,n){if(t==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?s!==e||!n:!e.has(s))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?n:t==="a"?n.call(s):n?n.value:e.get(s)},V,ye,nn,rn,bt,St,sn,xt,pe,vt,an,on,Ve,pr,As,hr,mr,fr,gr,ks,Ms="__json_buf",ln=class s{constructor(){V.add(this),this.messages=[],this.receivedMessages=[],ye.set(this,void 0),this.controller=new AbortController,nn.set(this,void 0),rn.set(this,()=>{}),bt.set(this,()=>{}),St.set(this,void 0),sn.set(this,()=>{}),xt.set(this,()=>{}),pe.set(this,{}),vt.set(this,!1),an.set(this,!1),on.set(this,!1),Ve.set(this,!1),hr.set(this,e=>{if(W(this,an,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new I),e instanceof I)return W(this,on,!0,"f"),this._emit("abort",e);if(e instanceof f)return this._emit("error",e);if(e instanceof Error){let t=new f(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new f(String(e)))}),W(this,nn,new Promise((e,t)=>{W(this,rn,e,"f"),W(this,bt,t,"f")}),"f"),W(this,St,new Promise((e,t)=>{W(this,sn,e,"f"),W(this,xt,t,"f")}),"f"),b(this,nn,"f").catch(()=>{}),b(this,St,"f").catch(()=>{})}static fromReadableStream(e){let t=new s;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,n){let r=new s;for(let i of t.messages)r._addMessageParam(i);return r._run(()=>r._createMessage(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),r}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},b(this,hr,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,n){let r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),b(this,V,"m",mr).call(this);let i=await e.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(let o of i)b(this,V,"m",fr).call(this,o);if(i.controller.signal?.aborted)throw new I;b(this,V,"m",gr).call(this)}_connected(){this.ended||(b(this,rn,"f").call(this),this._emit("connect"))}get ended(){return b(this,vt,"f")}get errored(){return b(this,an,"f")}get aborted(){return b(this,on,"f")}abort(){this.controller.abort()}on(e,t){return(b(this,pe,"f")[e]||(b(this,pe,"f")[e]=[])).push({listener:t}),this}off(e,t){let n=b(this,pe,"f")[e];if(!n)return this;let r=n.findIndex(i=>i.listener===t);return r>=0&&n.splice(r,1),this}once(e,t){return(b(this,pe,"f")[e]||(b(this,pe,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,n)=>{W(this,Ve,!0,"f"),e!=="error"&&this.once("error",n),this.once(e,t)})}async done(){W(this,Ve,!0,"f"),await b(this,St,"f")}get currentMessage(){return b(this,ye,"f")}async finalMessage(){return await this.done(),b(this,V,"m",pr).call(this)}async finalText(){return await this.done(),b(this,V,"m",As).call(this)}_emit(e,...t){if(b(this,vt,"f"))return;e==="end"&&(W(this,vt,!0,"f"),b(this,sn,"f").call(this));let n=b(this,pe,"f")[e];if(n&&(b(this,pe,"f")[e]=n.filter(r=>!r.once),n.forEach(({listener:r})=>r(...t))),e==="abort"){let r=t[0];!b(this,Ve,"f")&&!n?.length&&Promise.reject(r),b(this,bt,"f").call(this,r),b(this,xt,"f").call(this,r),this._emit("end");return}if(e==="error"){let r=t[0];!b(this,Ve,"f")&&!n?.length&&Promise.reject(r),b(this,bt,"f").call(this,r),b(this,xt,"f").call(this,r),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",b(this,V,"m",pr).call(this))}async _fromReadableStream(e,t){let n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),b(this,V,"m",mr).call(this),this._connected();let r=se.fromReadableStream(e,this.controller);for await(let i of r)b(this,V,"m",fr).call(this,i);if(r.controller.signal?.aborted)throw new I;b(this,V,"m",gr).call(this)}[(ye=new WeakMap,nn=new WeakMap,rn=new WeakMap,bt=new WeakMap,St=new WeakMap,sn=new WeakMap,xt=new WeakMap,pe=new WeakMap,vt=new WeakMap,an=new WeakMap,on=new WeakMap,Ve=new WeakMap,hr=new WeakMap,V=new WeakSet,pr=function(){if(this.receivedMessages.length===0)throw new f("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},As=function(){if(this.receivedMessages.length===0)throw new f("stream ended without producing a Message with role=assistant");let t=this.receivedMessages.at(-1).content.filter(n=>n.type==="text").map(n=>n.text);if(t.length===0)throw new f("stream ended without producing a content block with type=text");return t.join(" ")},mr=function(){this.ended||W(this,ye,void 0,"f")},fr=function(t){if(this.ended)return;let n=b(this,V,"m",ks).call(this,t);switch(this._emit("streamEvent",t,n),t.type){case"content_block_delta":{let r=n.content.at(-1);t.delta.type==="text_delta"&&r.type==="text"?this._emit("text",t.delta.text,r.text||""):t.delta.type==="input_json_delta"&&r.type==="tool_use"&&r.input&&this._emit("inputJson",t.delta.partial_json,r.input);break}case"message_stop":{this._addMessageParam(n),this._addMessage(n,!0);break}case"content_block_stop":{this._emit("contentBlock",n.content.at(-1));break}case"message_start":{W(this,ye,n,"f");break}case"content_block_start":case"message_delta":break}},gr=function(){if(this.ended)throw new f("stream has ended, this shouldn't happen");let t=b(this,ye,"f");if(!t)throw new f("request ended without sending any chunks");return W(this,ye,void 0,"f"),t},ks=function(t){let n=b(this,ye,"f");if(t.type==="message_start"){if(n)throw new f(`Unexpected event order, got ${t.type} before receiving "message_stop"`);return t.message}if(!n)throw new f(`Unexpected event order, got ${t.type} before "message_start"`);switch(t.type){case"message_stop":return n;case"message_delta":return n.stop_reason=t.delta.stop_reason,n.stop_sequence=t.delta.stop_sequence,n.usage.output_tokens=t.usage.output_tokens,n;case"content_block_start":return n.content.push(t.content_block),n;case"content_block_delta":{let r=n.content.at(t.index);if(r?.type==="text"&&t.delta.type==="text_delta")r.text+=t.delta.text;else if(r?.type==="tool_use"&&t.delta.type==="input_json_delta"){let i=r[Ms]||"";i+=t.delta.partial_json,Object.defineProperty(r,Ms,{value:i,enumerable:!1,writable:!0}),i&&(r.input=Xt(i))}return n}case"content_block_stop":return n}},Symbol.asyncIterator)](){let e=[],t=[],n=!1;return this.on("streamEvent",r=>{let i=t.shift();i?i.resolve(r):e.push(r)}),this.on("end",()=>{n=!0;for(let r of t)r.resolve(void 0);t.length=0}),this.on("abort",r=>{n=!0;for(let i of t)i.reject(r);t.length=0}),this.on("error",r=>{n=!0;for(let i of t)i.reject(r);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((i,o)=>t.push({resolve:i,reject:o})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new se(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};var ke=class extends L{create(e,t){return e.model in Rs&&console.warn(`The model '${e.model}' is deprecated and will reach end-of-life on ${Rs[e.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages",{body:e,timeout:this._client._options.timeout??6e5,...t,stream:e.stream??!1})}stream(e,t){return ln.createMessage(this,e,t)}},Rs={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024"};var Is,x=class extends jt{constructor({baseURL:e=Gt("ANTHROPIC_BASE_URL"),apiKey:t=Gt("ANTHROPIC_API_KEY")??null,authToken:n=Gt("ANTHROPIC_AUTH_TOKEN")??null,...r}={}){let i={apiKey:t,authToken:n,...r,baseURL:e||"https://api.anthropic.com"};if(!i.dangerouslyAllowBrowser&&Cs())throw new f(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Anthropic({ apiKey, dangerouslyAllowBrowser: true });

TODO: link!
`);super({baseURL:i.baseURL,timeout:i.timeout??6e5,httpAgent:i.httpAgent,maxRetries:i.maxRetries,fetch:i.fetch}),this.completions=new Ae(this),this.messages=new ke(this),this.beta=new de(this),this._options=i,this.apiKey=t,this.authToken=n}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),...this._options.dangerouslyAllowBrowser?{"anthropic-dangerous-direct-browser-access":"true"}:void 0,"anthropic-version":"2023-06-01",...this._options.defaultHeaders}}validateHeaders(e,t){if(!(this.apiKey&&e["x-api-key"])&&t["x-api-key"]!==null&&!(this.authToken&&e.authorization)&&t.authorization!==null)throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}authHeaders(e){let t=this.apiKeyAuth(e),n=this.bearerAuth(e);return t!=null&&!mt(t)?t:n!=null&&!mt(n)?n:{}}apiKeyAuth(e){return this.apiKey==null?{}:{"X-Api-Key":this.apiKey}}bearerAuth(e){return this.authToken==null?{}:{Authorization:`Bearer ${this.authToken}`}}};Is=x;x.Anthropic=Is;x.HUMAN_PROMPT=`

Human:`;x.AI_PROMPT=`

Assistant:`;x.DEFAULT_TIMEOUT=6e5;x.AnthropicError=f;x.APIError=k;x.APIConnectionError=me;x.APIConnectionTimeoutError=Ue;x.APIUserAbortError=I;x.NotFoundError=ot;x.ConflictError=lt;x.RateLimitError=ut;x.BadRequestError=st;x.AuthenticationError=it;x.InternalServerError=dt;x.PermissionDeniedError=at;x.UnprocessableEntityError=ct;x.toFile=gs;x.fileFromPath=Bt;var{HUMAN_PROMPT:tl,AI_PROMPT:nl}=x;x.Completions=Ae;x.Messages=ke;x.Beta=de;var Os=x;var cn=class{constructor(e,t={}){this.client=null;this.keychainService=e,this.defaultModel=t.model||"claude-sonnet-4-20250514",this.defaultMaxTokens=t.maxTokens||4096,this.defaultTemperature=t.temperature||.7}async getClient(){if(this.client)return this.client;let e=await this.keychainService.getApiKey();if(!e)throw new Error("No API key configured. Please add your Anthropic API key in settings.");return this.client=new Os({apiKey:e,dangerouslyAllowBrowser:!0}),this.client}resetClient(){this.client=null}async*createMessageStream(e){let t=await this.getClient(),n=e.messages?.map(r=>({role:r.role,content:r.content}))||[];n.push({role:"user",content:e.prompt});try{yield{type:"start"};let r=await t.messages.stream({model:e.model||this.defaultModel,max_tokens:e.maxTokens||this.defaultMaxTokens,temperature:e.temperature??this.defaultTemperature,system:e.systemPrompt,messages:n});for await(let i of r)i.type==="content_block_delta"&&i.delta.type==="text_delta"&&(yield{type:"text",text:i.delta.text});yield{type:"stop"}}catch(r){throw yield{type:"error",error:r instanceof Error?r.message:"Unknown error occurred"},r}}async createMessage(e){let t=await this.getClient(),n=e.messages?.map(o=>({role:o.role,content:o.content}))||[];n.push({role:"user",content:e.prompt});let r=await t.messages.create({model:e.model||this.defaultModel,max_tokens:e.maxTokens||this.defaultMaxTokens,temperature:e.temperature??this.defaultTemperature,system:e.systemPrompt,messages:n});return{content:r.content.filter(o=>o.type==="text").map(o=>o.text).join(""),model:r.model,inputTokens:r.usage.input_tokens,outputTokens:r.usage.output_tokens,stopReason:r.stop_reason||"unknown"}}async complete(e,t,n){let r=t?`You are a helpful AI assistant integrated into Obsidian. Respond concisely and directly. Context from the user's note:

${t}`:"You are a helpful AI assistant integrated into Obsidian. Respond concisely and directly.";return(await this.createMessage({prompt:e,systemPrompt:r,maxTokens:n?.maxTokens||1024,temperature:n?.temperature??.7})).content}async*completeStream(e,t,n){let r=t?`You are a helpful AI assistant integrated into Obsidian. Respond concisely and directly. Context from the user's note:

${t}`:"You are a helpful AI assistant integrated into Obsidian. Respond concisely and directly.";for await(let i of this.createMessageStream({prompt:e,systemPrompt:r,maxTokens:n?.maxTokens||1024,temperature:n?.temperature??.7}))if(i.type==="text"&&i.text)yield i.text;else if(i.type==="error")throw new Error(i.error)}estimateTokens(e){return Math.ceil(e.length/4)}async healthCheck(){try{return await this.getClient(),await this.createMessage({prompt:'Say "ok"',maxTokens:10}),{ok:!0}}catch(e){return{ok:!1,error:e instanceof Error?e.message:"Unknown error"}}}updateDefaults(e){e.model&&(this.defaultModel=e.model),e.maxTokens&&(this.defaultMaxTokens=e.maxTokens),e.temperature!==void 0&&(this.defaultTemperature=e.temperature)}},K={summarize:s=>`Summarize the following text concisely:

${s}`,expand:s=>`Expand on the following text with more detail:

${s}`,rewrite:s=>`Rewrite the following text to improve clarity and flow:

${s}`,explain:s=>`Explain the following text in simple terms:

${s}`,translate:(s,e)=>`Translate the following text to ${e}:

${s}`,fixGrammar:s=>`Fix any grammar and spelling errors in the following text. Only return the corrected text:

${s}`,makeBullets:s=>`Convert the following text into a bullet point list:

${s}`,makeTable:s=>`Convert the following information into a markdown table:

${s}`,continue:s=>`Continue writing from where this text ends:

${s}`,custom:(s,e)=>`${e}

Text:
${s}`};var g=require("obsidian");var un=class extends g.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h1",{text:"Obsidian CC Settings"}),e.createEl("p",{text:"The ultimate Obsidian companion - Claude AI with QMD semantic search",cls:"setting-item-description"}),this.renderApiSection(e),this.renderClaudeCodeSection(e),this.renderTriggersSection(e),this.renderQMDSection(e),this.renderTasksSection(e),this.renderGitHubSection(e),this.renderSecuritySection(e),this.renderAdvancedSection(e)}renderClaudeCodeSection(e){e.createEl("h2",{text:"Claude Code Integration"}),e.createEl("p",{text:"Connect Obsidian CC with Claude Code for seamless vault access from the CLI",cls:"setting-item-description"}),new g.Setting(e).setName("Enable Claude Code integration").setDesc("Allow Claude Code to access your vault via MCP").addToggle(t=>{t.setValue(this.plugin.settings.claudeCodeIntegration).onChange(async n=>{this.plugin.settings.claudeCodeIntegration=n,await this.plugin.saveSettings()})}),new g.Setting(e).setName("Auto-update CLAUDE.md").setDesc("Automatically add vault context to your CLAUDE.md file").addToggle(t=>{t.setValue(this.plugin.settings.autoUpdateClaudeMd).onChange(async n=>{this.plugin.settings.autoUpdateClaudeMd=n,await this.plugin.saveSettings(),n&&new g.Notice("CLAUDE.md will be updated with vault context")})}),new g.Setting(e).setName("Enable MCP server").setDesc("Start an MCP server for Claude Code/Desktop to connect").addToggle(t=>{t.setValue(this.plugin.settings.mcpServerEnabled).onChange(async n=>{this.plugin.settings.mcpServerEnabled=n,await this.plugin.saveSettings(),n&&new g.Notice("MCP server will start on next Obsidian launch")})}),new g.Setting(e).setName("MCP server port").setDesc("Port for the MCP WebSocket server").addText(t=>{t.setPlaceholder("3333").setValue(String(this.plugin.settings.mcpServerPort)).onChange(async n=>{let r=parseInt(n,10);!isNaN(r)&&r>1024&&r<65535&&(this.plugin.settings.mcpServerPort=r,await this.plugin.saveSettings())})}),new g.Setting(e).setName("Update CLAUDE.md now").setDesc("Manually trigger CLAUDE.md update with vault context").addButton(t=>{t.setButtonText("Update").setCta().onClick(async()=>{new g.Notice("CLAUDE.md updated with vault context")})})}renderApiSection(e){if(e.createEl("h2",{text:"API Configuration"}),new g.Setting(e).setName("Anthropic API Key").setDesc(this.getApiKeyDescription()).addText(n=>{n.inputEl.type="password",n.setPlaceholder("sk-ant-..."),this.plugin.keychainService.getApiKey().then(r=>{r&&n.setValue("\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022")}),n.onChange(async r=>{r&&r!=="\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022"&&(this.plugin.keychainService.validateApiKeyFormat(r)?(await this.plugin.keychainService.storeApiKey(r),new g.Notice("API key saved securely"),n.setValue("\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022")):new g.Notice("Invalid API key format. Should start with sk-ant-"))})}).addButton(n=>{n.setIcon("trash").setTooltip("Delete API key").onClick(async()=>{await this.plugin.keychainService.deleteApiKey(),new g.Notice("API key deleted"),this.display()})}),!this.plugin.keychainService.getStorageStatus().secure){let n=e.createEl("div",{cls:"mod-warning setting-item-description"});n.createEl("strong",{text:"Warning: "}),n.appendText("Secure storage unavailable. Consider using ANTHROPIC_API_KEY environment variable.")}new g.Setting(e).setName("Model").setDesc("Claude model to use for AI operations").addDropdown(n=>{for(let r of Xr)n.addOption(r.value,r.label);n.setValue(this.plugin.settings.model).onChange(async r=>{this.plugin.settings.model=r,await this.plugin.saveSettings()})}),new g.Setting(e).setName("Agentic Backend").setDesc("Backend for @cc agentic sessions").addDropdown(n=>{n.addOption("sdk","Claude Agent SDK (Recommended)").addOption("cli","Claude CLI").setValue(this.plugin.settings.agenticBackend).onChange(async r=>{this.plugin.settings.agenticBackend=r,await this.plugin.saveSettings()})})}renderTriggersSection(e){e.createEl("h2",{text:"@ Triggers"}),new g.Setting(e).setName("Enable @claude inline mode").setDesc("Quick inline completions - Notion-style").addToggle(t=>{t.setValue(this.plugin.settings.inlineEnabled).onChange(async n=>{this.plugin.settings.inlineEnabled=n,await this.plugin.saveSettings()})}),new g.Setting(e).setName("Inline trigger").setDesc("Text pattern to trigger inline mode").addText(t=>{t.setPlaceholder("@claude").setValue(this.plugin.settings.inlineTrigger).onChange(async n=>{this.plugin.settings.inlineTrigger=n||"@claude",await this.plugin.saveSettings()})}),new g.Setting(e).setName("Enable @cc agentic mode").setDesc("Full agentic sessions with file operations and tool use").addToggle(t=>{t.setValue(this.plugin.settings.agenticEnabled).onChange(async n=>{this.plugin.settings.agenticEnabled=n,await this.plugin.saveSettings()})}),new g.Setting(e).setName("Agentic trigger").setDesc("Text pattern to trigger agentic mode").addText(t=>{t.setPlaceholder("@cc").setValue(this.plugin.settings.agenticTrigger).onChange(async n=>{this.plugin.settings.agenticTrigger=n||"@cc",await this.plugin.saveSettings()})})}renderQMDSection(e){e.createEl("h2",{text:"QMD Semantic Search"}),new g.Setting(e).setName("Enable QMD").setDesc("Use QMD for semantic vault search").addToggle(t=>{t.setValue(this.plugin.settings.qmdEnabled).onChange(async n=>{this.plugin.settings.qmdEnabled=n,await this.plugin.saveSettings()})}),new g.Setting(e).setName("QMD binary path").setDesc("Leave empty for auto-detection").addText(t=>{t.setPlaceholder("/usr/local/bin/qmd").setValue(this.plugin.settings.qmdPath).onChange(async n=>{this.plugin.settings.qmdPath=n,await this.plugin.saveSettings()})}),new g.Setting(e).setName("Auto-index vault").setDesc("Automatically index vault on plugin load").addToggle(t=>{t.setValue(this.plugin.settings.autoIndex).onChange(async n=>{this.plugin.settings.autoIndex=n,await this.plugin.saveSettings()})}),new g.Setting(e).setName("Search mode").setDesc("QMD search strategy").addDropdown(t=>{for(let n of Jr)t.addOption(n.value,n.label);t.setValue(this.plugin.settings.searchMode).onChange(async n=>{this.plugin.settings.searchMode=n,await this.plugin.saveSettings()})})}renderTasksSection(e){e.createEl("h2",{text:"Tasks Integration"}),new g.Setting(e).setName("Enable Tasks integration").setDesc("AI can read and write Obsidian Tasks").addToggle(t=>{t.setValue(this.plugin.settings.tasksIntegration).onChange(async n=>{this.plugin.settings.tasksIntegration=n,await this.plugin.saveSettings()})}),new g.Setting(e).setName("Task format").setDesc("Task syntax to use").addDropdown(t=>{for(let n of Qr)t.addOption(n.value,n.label);t.setValue(this.plugin.settings.taskFormat).onChange(async n=>{this.plugin.settings.taskFormat=n,await this.plugin.saveSettings()})})}renderGitHubSection(e){e.createEl("h2",{text:"GitHub Integration"}),new g.Setting(e).setName("GitHub Token").setDesc("Personal access token for cloning private repos").addText(t=>{t.inputEl.type="password",t.setPlaceholder("ghp_..."),this.plugin.keychainService.getGitHubToken().then(n=>{n&&t.setValue("\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022")}),t.onChange(async n=>{n&&n!=="\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022"&&(await this.plugin.keychainService.storeGitHubToken(n),new g.Notice("GitHub token saved securely"),t.setValue("\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022"))})}).addButton(t=>{t.setIcon("trash").setTooltip("Delete GitHub token").onClick(async()=>{await this.plugin.keychainService.deleteGitHubToken(),new g.Notice("GitHub token deleted"),this.display()})}),new g.Setting(e).setName("Default clone path").setDesc("Where to clone repos (relative to vault)").addText(t=>{t.setPlaceholder("Projects/").setValue(this.plugin.settings.defaultClonePath).onChange(async n=>{this.plugin.settings.defaultClonePath=n,await this.plugin.saveSettings()})})}renderSecuritySection(e){e.createEl("h2",{text:"Security"}),new g.Setting(e).setName("Require approval for file writes").setDesc("Ask before AI writes or modifies files").addToggle(r=>{r.setValue(this.plugin.settings.requireApproval).onChange(async i=>{this.plugin.settings.requireApproval=i,await this.plugin.saveSettings()})}),new g.Setting(e).setName("Audit logging").setDesc("Log all AI operations to console").addToggle(r=>{r.setValue(this.plugin.settings.auditLogging).onChange(async i=>{this.plugin.settings.auditLogging=i,await this.plugin.saveSettings()})});let t=this.plugin.keychainService.getStorageStatus(),n=e.createEl("div",{cls:"setting-item-description"});n.createEl("strong",{text:"Storage backend: "}),n.appendText(t.backend),t.secure?n.appendText(" (secure)"):n.appendText(" (not secure)")}renderAdvancedSection(e){e.createEl("h2",{text:"Advanced"}),new g.Setting(e).setName("Debug mode").setDesc("Enable verbose logging").addToggle(t=>{t.setValue(this.plugin.settings.debugMode).onChange(async n=>{this.plugin.settings.debugMode=n,await this.plugin.saveSettings()})}),new g.Setting(e).setName("Custom system prompt").setDesc("Prepend to all AI requests (optional)").addTextArea(t=>{t.setPlaceholder("You are a helpful assistant...").setValue(this.plugin.settings.customSystemPrompt).onChange(async n=>{this.plugin.settings.customSystemPrompt=n,await this.plugin.saveSettings()}),t.inputEl.rows=4,t.inputEl.cols=50}),new g.Setting(e).setName("Request timeout (ms)").setDesc("Maximum time to wait for API response").addText(t=>{t.setPlaceholder("60000").setValue(String(this.plugin.settings.timeout)).onChange(async n=>{let r=parseInt(n,10);!isNaN(r)&&r>0&&(this.plugin.settings.timeout=r,await this.plugin.saveSettings())})}),new g.Setting(e).setName("Max tokens").setDesc("Maximum tokens in AI response").addText(t=>{t.setPlaceholder("4096").setValue(String(this.plugin.settings.maxTokens)).onChange(async n=>{let r=parseInt(n,10);!isNaN(r)&&r>0&&(this.plugin.settings.maxTokens=r,await this.plugin.saveSettings())})}),new g.Setting(e).setName("Temperature").setDesc("AI creativity (0 = focused, 1 = creative)").addSlider(t=>{t.setLimits(0,1,.1).setValue(this.plugin.settings.temperature).setDynamicTooltip().onChange(async n=>{this.plugin.settings.temperature=n,await this.plugin.saveSettings()})})}getApiKeyDescription(){let e=this.plugin.keychainService.getStorageStatus();return e.secure?`Stored securely in ${e.backend}. Or use ANTHROPIC_API_KEY env var.`:"Warning: Secure storage unavailable. Consider using ANTHROPIC_API_KEY environment variable."}};var dn=class{constructor(e){this.claudeApi=e}async execute(e,t){if(e.type!=="claude")throw new Error("InlineRenderer only handles @claude triggers");let n=e.command,r=this.buildPrompt(n,t,e.args);try{let i=await this.claudeApi.complete(r,void 0,{maxTokens:this.getMaxTokensForCommand(n),temperature:this.getTemperatureForCommand(n)});return this.formatResponse(n,i)}catch(i){throw new Error(`Failed to execute @claude ${n}: ${i instanceof Error?i.message:"Unknown error"}`)}}async executeStream(e,t,n){if(e.type!=="claude")throw new Error("InlineRenderer only handles @claude triggers");let r=e.command,i=this.buildPrompt(r,t,e.args),o="";try{for await(let l of this.claudeApi.completeStream(i,void 0,{maxTokens:this.getMaxTokensForCommand(r),temperature:this.getTemperatureForCommand(r)}))o+=l,n(l);return this.formatResponse(r,o)}catch(l){throw new Error(`Failed to execute @claude ${r}: ${l instanceof Error?l.message:"Unknown error"}`)}}buildPrompt(e,t,n){switch(e){case"summarize":return K.summarize(t);case"expand":return K.expand(t);case"rewrite":return K.rewrite(t);case"explain":return K.explain(t);case"translate":if(!n)throw new Error("Translate requires a target language");return K.translate(t,n);case"fix":return K.fixGrammar(t);case"bullets":return K.makeBullets(t);case"table":return K.makeTable(t);case"continue":return K.continue(t);case"ask":if(!n)throw new Error("@claude requires a prompt");return K.custom(t,n);default:if(n)return K.custom(t,n);throw new Error(`Unknown command: ${e}`)}}getMaxTokensForCommand(e){switch(e){case"summarize":return 512;case"fix":return 1024;case"expand":case"continue":return 2048;case"bullets":case"table":return 1024;default:return 1024}}getTemperatureForCommand(e){switch(e){case"fix":return .1;case"summarize":case"explain":return .5;case"expand":case"continue":return .8;case"rewrite":return .7;default:return .7}}formatResponse(e,t){let n=t.trim();switch(n.startsWith('"')&&n.endsWith('"')&&(n=n.slice(1,-1)),e){case"bullets":!n.startsWith("-")&&!n.startsWith("*")&&(n=n.split(`
`).map(r=>r.trim()?`- ${r.trim()}`:"").join(`
`));break;case"table":n.includes("|")||console.warn("Table response missing markdown formatting");break;default:break}return n}getCommandDescription(e){return{summarize:"Create a concise summary of the text",expand:"Add more detail and depth to the text",rewrite:"Improve clarity, flow, and readability",explain:"Explain the text in simpler terms",translate:"Translate to another language",fix:"Fix grammar and spelling errors",bullets:"Convert to bullet point list",table:"Convert to markdown table",continue:"Continue writing from where text ends",ask:"Ask Claude anything about the text"}[e]||"Execute custom command"}validateContext(e,t){let n=this.claudeApi.estimateTokens(t);if(n<5)return{valid:!1,warning:"Please provide more context (select text or add content above)"};if(n>5e4)return{valid:!0,warning:"Context is very long - response may be truncated or slow"};switch(e){case"table":if(!t.includes(`
`)&&t.split(",").length<2)return{valid:!0,warning:"Table works best with structured data (lists, CSV, etc.)"};break;case"translate":break}return{valid:!0}}};var yr=["summarize","expand","rewrite","explain","translate","fix","bullets","table","continue","ask"];function Ds(s){return yr.includes(s)}var pn=class{constructor(e="@claude",t="@cc"){this.claudeTrigger=e,this.ccTrigger=t}setTriggers(e,t){this.claudeTrigger=e,this.ccTrigger=t}parseLine(e){let t=this.parseClaudeTrigger(e);if(t)return t;let n=this.parseCCTrigger(e);return n||null}parseClaudeTrigger(e){let t=this.escapeRegex(this.claudeTrigger),n=new RegExp(`${t}\\s+(\\w+)(?:\\s+(.*))?$`,"i"),r=e.match(n);if(r){let l=r.index,d=r[1].toLowerCase();return Ds(d)?{type:"claude",command:d,args:r[2]?.trim()||"",fullMatch:r[0],startIndex:l,endIndex:l+r[0].length}:{type:"claude",command:"ask",args:(r[1]+(r[2]?" "+r[2]:"")).trim(),fullMatch:r[0],startIndex:l,endIndex:l+r[0].length}}let i=new RegExp(`${t}$`,"i"),o=e.match(i);if(o){let l=o.index;return{type:"claude",command:"ask",args:"",fullMatch:o[0],startIndex:l,endIndex:l+o[0].length}}return null}parseCCTrigger(e){let t=this.escapeRegex(this.ccTrigger),n=new RegExp(`${t}\\s+(.+)$`,"i"),r=e.match(n);if(!r)return null;let i=r.index;return{type:"cc",command:"",args:r[1].trim(),fullMatch:r[0],startIndex:i,endIndex:i+r[0].length}}isCursorInTrigger(e,t){let n=this.parseLine(e);return n?t>=n.startIndex&&t<=n.endIndex:!1}findAllTriggers(e){let t=e.split(`
`),n=[],r=0;for(let i of t){let o=this.parseLine(i);o&&n.push({...o,startIndex:r+o.startIndex,endIndex:r+o.endIndex}),r+=i.length+1}return n}getCommandSuggestions(e){let t=e.toLowerCase();return yr.filter(n=>n.startsWith(t))}validateTrigger(e){if(e.type==="claude"){if(!Ds(e.command))return{valid:!1,error:`Unknown command: ${e.command}. Available: ${yr.join(", ")}`};if(e.command==="translate"&&!e.args)return{valid:!1,error:"Translate command requires a target language"};if(e.command==="ask"&&!e.args)return{valid:!1,error:"@claude requires a prompt (e.g., @claude what is this about?)"}}return e.type==="cc"&&!e.args?{valid:!1,error:"@cc requires a prompt"}:{valid:!0}}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}static getHelpText(){return"\n## Inline Mode (@claude)\nQuick completions that replace text inline:\n- `@claude summarize` - Summarize selected/previous text\n- `@claude expand` - Add more detail\n- `@claude rewrite` - Improve clarity\n- `@claude explain` - Simplify explanation\n- `@claude translate [language]` - Translate text\n- `@claude fix` - Fix grammar/spelling\n- `@claude bullets` - Convert to bullet points\n- `@claude table` - Convert to markdown table\n- `@claude continue` - Continue writing\n\n## Agentic Mode (@cc)\nFull AI sessions with file access:\n- `@cc [any prompt]` - Start agentic session\n\nPress Tab to execute a trigger.\n    ".trim()}};var yn=require("obsidian"),Ws=require("http"),js=require("crypto");var wr=require("obsidian"),Me=qe(require("path")),Ta=[".md",".txt",".json",".yaml",".yml",".csv"],Ca=[/\.\./,/^~\//,/^\$/,/%2e%2e/i,/%252e%252e/i,/\x00/],hn=class{constructor(e){this.vaultPath=e}validate(e){if(!e||typeof e!="string")return{valid:!1,error:"Path is required"};if(e.trim()==="")return{valid:!1,error:"Path cannot be empty"};for(let o of Ca)if(o.test(e))return{valid:!1,error:"Path contains dangerous pattern"};if(e.startsWith("/")||/^[A-Za-z]:/.test(e))return{valid:!1,error:"Absolute paths are not allowed"};let t=(0,wr.normalizePath)(e),n=this.vaultPath.endsWith("/")?this.vaultPath:this.vaultPath+"/",r=Me.resolve(this.vaultPath,t);if(r!==this.vaultPath&&!r.startsWith(n))return{valid:!1,error:"Path escapes vault directory"};let i=t.split("/");for(let o of i)if(o.startsWith(".")&&o!==".")return{valid:!1,error:"Hidden files/folders are not allowed"};return{valid:!0,sanitizedPath:t}}validateWithExtension(e,t=!0){let n=this.validate(e);if(!n.valid)return n;let r=Me.extname(e).toLowerCase();if(!r&&t){let i=e+".md";return{valid:!0,sanitizedPath:(0,wr.normalizePath)(i)}}return r&&!Ta.includes(r)?{valid:!1,error:`Extension "${r}" is not allowed`}:n}resolveSafe(e){let t=this.validate(e);return!t.valid||!t.sanitizedPath?null:Me.join(this.vaultPath,t.sanitizedPath)}isWithinVault(e){return Me.resolve(e).startsWith(this.vaultPath)}validateFolder(e){if(!e||e==="")return{valid:!0,sanitizedPath:""};let t=this.validate(e);return t.valid?{valid:!0,sanitizedPath:t.sanitizedPath.replace(/\/+$/,"")}:t}getVaultPath(){return this.vaultPath}};var mn=class{constructor(e){this.logs=[];this.maxLogSize=1e3;this.settings=e}log(e){if(!this.settings.auditLogging)return;let t={...e,timestamp:new Date().toISOString()};this.logs.push(t),this.logs.length>this.maxLogSize&&(this.logs=this.logs.slice(-this.maxLogSize)),this.settings.debugMode&&console.log("[MCP Audit]",JSON.stringify(t,null,2))}logToolCall(e,t,n,r,i){this.log({type:"tool_call",tool:e,path:t,clientId:i,success:n,error:r})}logResourceRead(e,t,n,r){this.log({type:"resource_read",path:e,clientId:r,success:t,error:n})}logApprovalRequest(e,t,n){this.log({type:"approval_request",tool:e,path:t,clientId:n,success:!0})}logApprovalResponse(e,t,n,r){this.log({type:"approval_response",tool:e,path:t,clientId:r,success:n,details:{approved:n}})}getRecentLogs(e=50){return this.logs.slice(-e)}getLogsForTool(e,t=50){return this.logs.filter(n=>n.tool===e).slice(-t)}clearLogs(){this.logs=[]}exportLogs(){return JSON.stringify(this.logs,null,2)}updateSettings(e){this.settings=e}};var Ls=require("obsidian"),Ea=["write_note","add_task","complete_task"],fn=class{constructor(e,t,n){this.pendingApprovals=new Map;this.approvalTimeout=3e4;this.app=e,this.settings=t,this.auditLogger=n}requiresApproval(e){return this.settings.requireApproval?Ea.includes(e.tool):!1}async requestApproval(e){return new Promise(t=>{let n=`${Date.now()}-${Math.random().toString(36).substr(2,9)}`;this.auditLogger.logApprovalRequest(e.tool,e.path,e.clientId);let r=setTimeout(()=>{this.pendingApprovals.get(n)&&(this.pendingApprovals.delete(n),this.auditLogger.logApprovalResponse(e.tool,e.path,!1,e.clientId),t(!1))},this.approvalTimeout);this.pendingApprovals.set(n,{id:n,operation:e,resolve:o=>{clearTimeout(r),this.pendingApprovals.delete(n),this.auditLogger.logApprovalResponse(e.tool,e.path,o,e.clientId),t(o)},timeout:r}),new br(this.app,e,o=>{let l=this.pendingApprovals.get(n);l&&l.resolve(o)}).open()})}async executeWithApproval(e,t){if(this.requiresApproval(e)&&!await this.requestApproval(e))throw new Error("Operation denied by user");return t()}updateSettings(e){this.settings=e}cancelAll(){for(let[,e]of this.pendingApprovals)clearTimeout(e.timeout),e.resolve(!1);this.pendingApprovals.clear()}},br=class extends Ls.Modal{constructor(t,n,r){super(t);this.responded=!1;this.operation=n,this.callback=r}respond(t){this.responded||(this.responded=!0,this.callback(t),this.close())}onOpen(){let{contentEl:t}=this;t.createEl("h2",{text:"MCP Operation Approval"});let n=this.operation.tool.replace(/_/g," ").replace(/\b\w/g,d=>d.toUpperCase());t.createEl("p",{text:"Claude Code is requesting permission to perform the following operation:"});let r=t.createEl("div",{cls:"mcp-approval-details"});r.createEl("div",{cls:"mcp-approval-row",text:`Tool: ${n}`}),this.operation.path&&r.createEl("div",{cls:"mcp-approval-row",text:`Path: ${this.operation.path}`}),this.operation.action&&r.createEl("div",{cls:"mcp-approval-row",text:`Action: ${this.operation.action}`}),t.createEl("p",{text:"Do you want to allow this operation?",cls:"mcp-approval-question"});let i=t.createEl("div",{cls:"mcp-approval-buttons"});i.createEl("button",{text:"Deny",cls:"mod-warning"}).addEventListener("click",()=>this.respond(!1));let l=i.createEl("button",{text:"Allow",cls:"mod-cta"});l.addEventListener("click",()=>this.respond(!0)),l.focus()}onClose(){let{contentEl:t}=this;t.empty(),this.responded||(this.responded=!0,this.callback(!1))}};var Sr=qe(require("fs"));var Ns=require("child_process"),Fs=require("util"),_a=(0,Fs.promisify)(Ns.execFile);async function Re(s,e=[],t={}){let n={cwd:t.cwd,timeout:t.timeout||3e4,env:t.env||process.env,maxBuffer:t.maxBuffer||10485760};try{let{stdout:r,stderr:i}=await _a(s,e,n);return{stdout:r.toString(),stderr:i.toString(),status:"success",exitCode:0}}catch(r){let i=r;return{stdout:i.stdout?.toString()||"",stderr:i.stderr?.toString()||"",status:"error",exitCode:i.code,error:i}}}async function Bs(s,e=[]){let t=[`/usr/local/bin/${s}`,`/opt/homebrew/bin/${s}`,`/usr/bin/${s}`,`${process.env.HOME}/.local/bin/${s}`,`${process.env.HOME}/.bun/bin/${s}`,...e];for(let r of t)if((await Re(r,["--version"],{timeout:5e3})).status==="success")return r;let n=await Re("which",[s],{timeout:5e3});if(n.status==="success"){let r=n.stdout.trim();if(r)return r}return null}var Ke=class{constructor(e,t){this.qmdPath=null;this.isIndexed=!1;this.vaultPath=e,this.settings=t}getSearchPath(){return this.settings.qmdSearchScope==="home"?process.env.HOME||this.vaultPath:this.vaultPath}async initialize(){this.qmdPath=await this.detectQMD()}async detectQMD(){return this.settings.qmdPath&&Sr.existsSync(this.settings.qmdPath)?this.settings.qmdPath:Bs("qmd",[`${process.env.HOME}/.bun/bin/qmd`])}async isAvailable(){return this.qmdPath||(this.qmdPath=await this.detectQMD()),this.qmdPath?(await Re(this.qmdPath,["--version"],{timeout:5e3})).status==="success":!1}async getVersion(){if(!this.qmdPath)return null;let e=await Re(this.qmdPath,["--version"],{timeout:5e3});return e.status==="success"?e.stdout.trim():null}async isVaultIndexed(){if(!this.qmdPath)return!1;try{let t=`${this.getSearchPath()}/.qmd`;return Sr.existsSync(t)}catch{return!1}}async index(){if(!this.qmdPath)throw new Error("QMD is not available");let e=this.getSearchPath(),t=await Re(this.qmdPath,["index"],{cwd:e,timeout:3e5});if(t.status==="error")throw new Error(`Failed to index: ${t.stderr||t.error?.message}`);this.isIndexed=!0}async search(e,t={}){if(!this.qmdPath)throw new Error("QMD is not available");if(!this.settings.qmdEnabled)throw new Error("QMD is disabled in settings");let n=t.mode||this.settings.searchMode||"hybrid",r=t.limit||this.settings.maxSearchResults||10,i=["search"];switch(n){case"semantic":i.push("--semantic");break;case"keyword":i.push("--keyword");break;case"hybrid":default:break}i.push("--limit",r.toString()),t.folder&&i.push("--path",t.folder),i.push("--json"),i.push(e);let o=this.getSearchPath(),l=await Re(this.qmdPath,i,{cwd:o,timeout:3e4});if(l.status==="error")throw new Error(`Search failed: ${l.stderr||l.error?.message}`);try{return JSON.parse(l.stdout).map(u=>({path:u.path||u.file||"",score:u.score||u.similarity||0,snippet:u.snippet||u.content||"",title:u.title||this.extractTitle(u.path)||"",highlights:u.highlights||[]}))}catch{return this.parseTextOutput(l.stdout)}}parseTextOutput(e){let t=e.trim().split(`
`),n=[];for(let r of t){if(!r.trim())continue;let i=r.match(/^(.+\.md):?\s*(.*)$/);i&&n.push({path:i[1],score:1,snippet:i[2]||"",title:this.extractTitle(i[1])})}return n}extractTitle(e){if(!e)return"";let t=e.split("/");return t[t.length-1].replace(/\.md$/,"")}async updateSettings(e){this.settings=e,e.qmdPath!==this.qmdPath&&(this.qmdPath=await this.detectQMD())}getQMDPath(){return this.qmdPath}getInstallInstructions(){return`QMD is not installed. Install it with:

bun install -g https://github.com/tobi/qmd

Or visit: https://github.com/tobi/qmd`}};var xr=require("obsidian"),qs={highest:"\u{1F53A}",high:"\u23EB",medium:"\u{1F53C}",low:"\u{1F53D}",lowest:"\u23EC"},$s={"\u{1F53A}":"highest","\u23EB":"high","\u{1F53C}":"medium","\u{1F53D}":"low","\u23EC":"lowest"},Us={obsidianTasks:/^(\s*)-\s*\[([ xX])\]\s*(.+)$/,dataview:/^(\s*)-\s*\[([ xX])\]\s*(.+)$/,basic:/^(\s*)-\s*\[([ xX])\]\s*(.+)$/},he={due:/(?:|due::?\s*)(\d{4}-\d{2}-\d{2})/i,scheduled:/(?:|scheduled::?\s*)(\d{4}-\d{2}-\d{2})/i,start:/(?:|start::?\s*)(\d{4}-\d{2}-\d{2})/i,done:/(?:|done::?\s*)(\d{4}-\d{2}-\d{2})/i,created:/(?:|created::?\s*)(\d{4}-\d{2}-\d{2})/i},Hs=/(?:|recurrence::?\s*)([^\[\]]+)/i,Pa=/#[\w\-/]+/g,gn=class{constructor(e,t){this.vault=e,this.settings=t}parseTask(e,t,n){let r=this.settings.taskFormat==="obsidian-tasks"?"obsidianTasks":this.settings.taskFormat,i=Us[r]||Us.obsidianTasks,o=e.match(i);if(!o)return null;let[,l,d,u]=o,m=d.toLowerCase()==="x",S=u.match(he.due),T=u.match(he.scheduled),$=u.match(he.start),O=u.match(he.done),Se;for(let[C,xe]of Object.entries($s))if(u.includes(C)){Se=xe;break}let j=u.match(/priority::?\s*(highest|high|medium|low|lowest)/i);j&&(Se=j[1].toLowerCase());let Tn=u.match(Hs),Cn=u.match(Pa)||[],ee=u.replace(he.due,"").replace(he.scheduled,"").replace(he.start,"").replace(he.done,"").replace(he.created,"").replace(Hs,"").replace(/\[priority::\s*\w+\]/gi,"");for(let C of Object.keys($s))ee=ee.replace(C,"");return ee=ee.trim(),{id:`${t}:${n}`,description:ee,completed:m,dueDate:S?.[1],scheduledDate:T?.[1],startDate:$?.[1],doneDate:O?.[1],priority:Se,recurrence:Tn?.[1]?.trim(),tags:Cn.map(C=>C.slice(1)),filePath:t,lineNumber:n,rawLine:e}}formatTask(e,t=!1){let n=[];return n.push(t?"- [x]":"- [ ]"),n.push(e.description),e.tags&&e.tags.length>0&&n.push(e.tags.map(r=>`#${r}`).join(" ")),e.priority&&qs[e.priority]&&n.push(qs[e.priority]),e.dueDate&&n.push(`\u{1F4C5} ${e.dueDate}`),e.scheduledDate&&n.push(`\u23F3 ${e.scheduledDate}`),e.startDate&&n.push(`\u{1F6EB} ${e.startDate}`),e.recurrence&&n.push(`\u{1F501} ${e.recurrence}`),n.join(" ")}async queryTasks(e={}){let t=[],n=this.vault.getMarkdownFiles(),r=new Date().toISOString().split("T")[0];for(let i of n){if(e.inNote&&i.path!==e.inNote)continue;let l=(await this.vault.read(i)).split(`
`);for(let d=0;d<l.length;d++){let u=this.parseTask(l[d],i.path,d+1);u&&this.matchesQuery(u,e,r)&&t.push(u)}}return t.sort((i,o)=>i.completed!==o.completed?i.completed?1:-1:i.dueDate&&o.dueDate?i.dueDate.localeCompare(o.dueDate):i.dueDate?-1:o.dueDate?1:0),e.limit&&e.limit>0?t.slice(0,e.limit):t}matchesQuery(e,t,n){return!(t.status==="incomplete"&&e.completed||t.status==="complete"&&!e.completed||t.overdue&&(!e.dueDate||e.dueDate>=n||e.completed)||t.dueBefore&&e.dueDate&&e.dueDate>t.dueBefore||t.dueAfter&&e.dueDate&&e.dueDate<t.dueAfter||t.priority&&e.priority!==t.priority||t.tags&&t.tags.length>0&&!t.tags.some(i=>e.tags.includes(i.replace(/^#/,""))))}async addTask(e,t){let n=this.vault.getAbstractFileByPath(t);if(!(n instanceof xr.TFile))throw new Error(`Note not found: ${t}`);let r=await this.vault.read(n),i=this.formatTask(e),o=r+`
`+i;await this.vault.modify(n,o);let l=o.split(`
`).length;return this.parseTask(i,t,l)}async completeTask(e){let[t,n]=e.split(":"),r=parseInt(n,10),i=this.vault.getAbstractFileByPath(t);if(!(i instanceof xr.TFile))throw new Error(`Note not found: ${t}`);let l=(await this.vault.read(i)).split(`
`),d=r-1;if(d<0||d>=l.length)throw new Error(`Invalid line number: ${r}`);if(!this.parseTask(l[d],t,r))throw new Error(`No task found at line ${r}`);l[d]=l[d].replace(/- \[ \]/,"- [x]");let m=new Date().toISOString().split("T")[0];return l[d].includes("\u2705")||(l[d]+=` \u2705 ${m}`),await this.vault.modify(i,l.join(`
`)),this.parseTask(l[d],t,r)}updateSettings(e){this.settings=e}};var Aa=["http://localhost","http://127.0.0.1","https://localhost","https://127.0.0.1","app://obsidian.md"],wn=class{constructor(e,t){this.server=null;this.isRunning=!1;this.authToken="";this.requestCounts=new Map;this.rateLimit=100;this.app=e,this.settings=t;let n=this.app.vault.adapter.basePath;this.pathValidator=new hn(n),this.auditLogger=new mn(t),this.operationGuard=new fn(e,t,this.auditLogger),this.qmdClient=new Ke(n,t),this.tasksAdapter=new gn(this.app.vault,t)}async start(){if(this.isRunning)return;this.authToken=(0,js.randomUUID)(),await this.qmdClient.initialize(),this.server=(0,Ws.createServer)((t,n)=>{this.handleRequest(t,n)});let e=this.settings.mcpServerPort||3333;return new Promise((t,n)=>{this.server.listen(e,"127.0.0.1",()=>{this.isRunning=!0,console.log(`Obsidian CC MCP server started on port ${e}`),console.log(`Auth token: ${this.authToken}`),t()}),this.server.on("error",r=>{console.error("MCP server error:",r),n(r)})})}async stop(){if(!(!this.isRunning||!this.server))return new Promise(e=>{this.operationGuard.cancelAll(),this.server.close(()=>{this.isRunning=!1,this.server=null,console.log("Obsidian CC MCP server stopped"),e()})})}async handleRequest(e,t){let n=e.headers.origin||"";if((!n||Aa.some(d=>n.startsWith(d)))&&n&&t.setHeader("Access-Control-Allow-Origin",n),t.setHeader("Access-Control-Allow-Methods","GET, POST, OPTIONS"),t.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization"),t.setHeader("Access-Control-Allow-Credentials","true"),e.method==="OPTIONS"){t.writeHead(204),t.end();return}let i=e.socket.remoteAddress||"unknown";if(!this.checkRateLimit(i)){t.writeHead(429,{"Content-Type":"application/json"}),t.end(JSON.stringify({error:"Too many requests"}));return}if(e.method!=="POST"&&e.method!=="GET"){t.writeHead(405),t.end(JSON.stringify({error:"Method not allowed"}));return}let l=new URL(e.url||"/","http://127.0.0.1").pathname;try{if(l==="/health"){t.writeHead(200,{"Content-Type":"application/json"}),t.end(JSON.stringify({status:"ok",vault:this.app.vault.getName()}));return}if(l==="/auth/token"&&e.method==="GET"){if(i==="127.0.0.1"||i==="::1"||i==="::ffff:127.0.0.1"){t.writeHead(200,{"Content-Type":"application/json"}),t.end(JSON.stringify({token:this.authToken}));return}t.writeHead(403),t.end(JSON.stringify({error:"Forbidden"}));return}let d=e.headers.authorization;if(!d||d!==`Bearer ${this.authToken}`){t.writeHead(401,{"Content-Type":"application/json"}),t.end(JSON.stringify({error:"Unauthorized",hint:"Get token from /auth/token or check Obsidian CC settings"}));return}if(l==="/mcp/tools"&&e.method==="GET"){let u=this.getToolDefinitions();t.writeHead(200,{"Content-Type":"application/json"}),t.end(JSON.stringify({tools:u}));return}if(l==="/mcp/call"&&e.method==="POST"){let u=await this.readBody(e),m;try{m=JSON.parse(u)}catch{t.writeHead(400,{"Content-Type":"application/json"}),t.end(JSON.stringify({error:"Invalid JSON body"}));return}if(!m.tool||typeof m.tool!="string"){t.writeHead(400,{"Content-Type":"application/json"}),t.end(JSON.stringify({error:'Missing or invalid "tool" parameter'}));return}let S=await this.executeTool(m.tool,m.arguments||{});t.writeHead(200,{"Content-Type":"application/json"}),t.end(JSON.stringify(S));return}t.writeHead(404),t.end(JSON.stringify({error:"Not found"}))}catch(d){console.error("MCP request error:",d),t.writeHead(500,{"Content-Type":"application/json"}),t.end(JSON.stringify({error:String(d)}))}}checkRateLimit(e){let t=Date.now(),n=this.requestCounts.get(e);return!n||t>n.resetTime?(this.requestCounts.set(e,{count:1,resetTime:t+6e4}),!0):n.count>=this.rateLimit?!1:(n.count++,!0)}readBody(e){return new Promise((t,n)=>{let r="",i=!1,o=10*1024*1024;e.on("data",l=>{i||(r+=l,r.length>o&&(i=!0,e.destroy(),n(new Error("Request body too large"))))}),e.on("end",()=>!i&&t(r)),e.on("error",l=>!i&&n(l))})}getToolDefinitions(){return[{name:"read_note",description:"Read the content of a note from the Obsidian vault",inputSchema:{type:"object",properties:{path:{type:"string",description:'Path to the note relative to vault root (e.g., "folder/note.md")'},includeMetadata:{type:"boolean",description:"Include frontmatter metadata in response",default:!1}},required:["path"]}},{name:"write_note",description:"Create or update a note in the vault",inputSchema:{type:"object",properties:{path:{type:"string",description:"Path for the note relative to vault root"},content:{type:"string",description:"Full markdown content to write"},mode:{type:"string",enum:["create","replace","append"],description:"Write mode: create (new only), replace (overwrite), append",default:"replace"}},required:["path","content"]}},{name:"search_vault",description:"Search the vault using QMD semantic search",inputSchema:{type:"object",properties:{query:{type:"string",description:"Natural language search query"},mode:{type:"string",enum:["hybrid","semantic","keyword"],description:"Search mode",default:"hybrid"},limit:{type:"number",description:"Maximum number of results",default:10}},required:["query"]}},{name:"list_notes",description:"List notes in the vault or a specific folder",inputSchema:{type:"object",properties:{folder:{type:"string",description:"Folder path to list (empty for root)",default:""},recursive:{type:"boolean",description:"Include notes in subfolders",default:!1},includeMetadata:{type:"boolean",description:"Include basic metadata",default:!1}}}},{name:"list_tasks",description:"List tasks from the vault with optional filters",inputSchema:{type:"object",properties:{status:{type:"string",enum:["incomplete","complete","all"],description:"Filter by task status",default:"incomplete"},overdue:{type:"boolean",description:"Only show overdue tasks",default:!1},dueToday:{type:"boolean",description:"Only show tasks due today",default:!1},limit:{type:"number",description:"Maximum number of results",default:50}}}},{name:"add_task",description:"Add a new task to a note",inputSchema:{type:"object",properties:{description:{type:"string",description:"Task description"},dueDate:{type:"string",description:"Due date in YYYY-MM-DD format"},priority:{type:"string",enum:["highest","high","medium","low","lowest"],description:"Task priority"},notePath:{type:"string",description:"Note to add task to"}},required:["description","notePath"]}},{name:"complete_task",description:"Mark a task as complete",inputSchema:{type:"object",properties:{taskId:{type:"string",description:"Task identifier (filePath:lineNumber)"}},required:["taskId"]}}]}async executeTool(e,t){let n={tool:e,path:t.path,action:t.mode,timestamp:Date.now()};try{switch(e){case"read_note":return await this.readNote(t.path,t.includeMetadata);case"write_note":return await this.operationGuard.executeWithApproval(n,()=>this.writeNote(t.path,t.content,t.mode));case"search_vault":return await this.searchVault(t.query,t.mode,t.limit);case"list_notes":return await this.listNotes(t.folder,t.recursive,t.includeMetadata);case"list_tasks":return await this.listTasks(t);case"add_task":return await this.operationGuard.executeWithApproval(n,()=>this.addTask(t));case"complete_task":return await this.operationGuard.executeWithApproval(n,()=>this.completeTask(t.taskId));default:return{content:[{type:"text",text:JSON.stringify({error:`Unknown tool: ${e}`})}],isError:!0}}}catch(r){return this.auditLogger.logToolCall(e,t.path,!1,String(r)),{content:[{type:"text",text:JSON.stringify({error:String(r)})}],isError:!0}}}async readNote(e,t=!1){let n=this.pathValidator.validateWithExtension(e);if(!n.valid)throw new Error(n.error);let r=this.app.vault.getAbstractFileByPath(n.sanitizedPath);if(!(r instanceof yn.TFile))throw new Error(`Note not found: ${e}`);let i=await this.app.vault.read(r);this.auditLogger.logToolCall("read_note",e,!0);let o={content:i};if(t){let l=this.app.metadataCache.getFileCache(r);o.metadata={path:r.path,name:r.name,size:r.stat.size,created:r.stat.ctime,modified:r.stat.mtime,frontmatter:l?.frontmatter,tags:l?.tags?.map(d=>d.tag)}}return{content:[{type:"text",text:JSON.stringify(o,null,2)}]}}async writeNote(e,t,n="replace"){let r=this.pathValidator.validateWithExtension(e);if(!r.valid)throw new Error(r.error);let i=r.sanitizedPath,o=this.app.vault.getAbstractFileByPath(i);if(n==="create"&&o)throw new Error(`Note already exists: ${e}`);if(n==="append"){if(!(o instanceof yn.TFile))throw new Error(`Note not found for append: ${e}`);t=await this.app.vault.read(o)+`
`+t}let l=i.substring(0,i.lastIndexOf("/"));return l&&await this.ensureFolder(l),o instanceof yn.TFile?await this.app.vault.modify(o,t):await this.app.vault.create(i,t),this.auditLogger.logToolCall("write_note",e,!0),{content:[{type:"text",text:JSON.stringify({success:!0,path:i,mode:n,uri:`obsidian://open?vault=${encodeURIComponent(this.app.vault.getName())}&file=${encodeURIComponent(i.replace(/\.md$/,""))}`})}]}}async ensureFolder(e){let t=this.pathValidator.validateFolder(e);if(!t.valid)throw new Error(t.error);this.app.vault.getAbstractFileByPath(t.sanitizedPath)||await this.app.vault.createFolder(t.sanitizedPath)}async searchVault(e,t="hybrid",n=10){if(!await this.qmdClient.isAvailable())return{content:[{type:"text",text:JSON.stringify({error:"QMD is not available",instructions:this.qmdClient.getInstallInstructions()})}],isError:!0};let i=await this.qmdClient.search(e,{mode:t,limit:n});return this.auditLogger.logToolCall("search_vault",void 0,!0),{content:[{type:"text",text:JSON.stringify({results:i},null,2)}]}}async listNotes(e="",t=!1,n=!1){let r=this.pathValidator.validateFolder(e);if(!r.valid)throw new Error(r.error);let i=this.app.vault.getMarkdownFiles(),o=r.sanitizedPath||"",d=i.filter(u=>{if(!o)return t||!u.path.includes("/");if(t)return u.path.startsWith(o+"/");let m=u.path.slice(o.length+1);return u.path.startsWith(o+"/")&&!m.includes("/")}).map(u=>{let m={path:u.path,name:u.basename};return n&&(m.size=u.stat.size,m.created=u.stat.ctime,m.modified=u.stat.mtime),m});return this.auditLogger.logToolCall("list_notes",e,!0),{content:[{type:"text",text:JSON.stringify({notes:d},null,2)}]}}async listTasks(e){let t=new Date().toISOString().split("T")[0],n=await this.tasksAdapter.queryTasks({status:e.status,overdue:e.overdue,dueBefore:e.dueToday?t:void 0,dueAfter:e.dueToday?t:void 0,limit:e.limit});return this.auditLogger.logToolCall("list_tasks",void 0,!0),{content:[{type:"text",text:JSON.stringify({tasks:n},null,2)}]}}async addTask(e){let t=this.pathValidator.validateWithExtension(e.notePath);if(!t.valid)throw new Error(t.error);let n=await this.tasksAdapter.addTask({description:e.description,dueDate:e.dueDate,priority:e.priority,tags:e.tags},t.sanitizedPath);return this.auditLogger.logToolCall("add_task",e.notePath,!0),{content:[{type:"text",text:JSON.stringify({success:!0,task:n,uri:`obsidian://open?vault=${encodeURIComponent(this.app.vault.getName())}&file=${encodeURIComponent(t.sanitizedPath.replace(/\.md$/,""))}`})}]}}async completeTask(e){let t=await this.tasksAdapter.completeTask(e);return this.auditLogger.logToolCall("complete_task",e,!0),{content:[{type:"text",text:JSON.stringify({success:!0,task:t})}]}}async updateSettings(e){this.settings=e,this.auditLogger.updateSettings(e),this.operationGuard.updateSettings(e),await this.qmdClient.updateSettings(e),this.tasksAdapter.updateSettings(e)}isServerRunning(){return this.isRunning}getPort(){return this.settings.mcpServerPort||3333}getAuthToken(){return this.authToken}};var we=require("obsidian");var X=require("obsidian"),Tt=require("child_process"),zs=qe(require("os")),Xe=class extends X.Modal{constructor(t,n){super(t);this.searchInput=null;this.resultsContainer=null;this.statusEl=null;this.results=[];this.isSearching=!1;this.qmdClient=n}async onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("cc-qmd-modal");let n=t.createDiv({cls:"cc-qmd-header"});n.createEl("h2",{text:"\u{1F50D} Semantic Search"});let r=this.qmdClient.getSearchPath(),i=r.includes("Obsidian")||r.includes("vault")?"Vault":"Home Directory";if(n.createEl("p",{text:`Searching: ${i}`,cls:"cc-qmd-subtitle"}),!await this.qmdClient.isAvailable()){this.showInstallPrompt(t);return}let l=t.createDiv({cls:"cc-qmd-search-container"});this.searchInput=l.createEl("input",{type:"text",placeholder:`Search ${i.toLowerCase()} semantically...`,cls:"cc-qmd-search-input"}),this.searchInput.addEventListener("keydown",async m=>{m.key==="Enter"&&!this.isSearching&&await this.performSearch()}),l.createEl("button",{text:"Search",cls:"cc-qmd-search-btn"}).addEventListener("click",()=>this.performSearch()),this.statusEl=t.createDiv({cls:"cc-qmd-status"}),this.resultsContainer=t.createDiv({cls:"cc-qmd-results"}),setTimeout(()=>this.searchInput?.focus(),50),await this.qmdClient.isVaultIndexed()||this.showIndexPrompt()}showInstallPrompt(t){let n=t.createDiv({cls:"cc-qmd-install-prompt"});n.createEl("h3",{text:"QMD Not Found"}),n.createEl("p",{text:"Install QMD for semantic search:"}),n.createEl("button",{text:"\u{1F4E6} Install QMD",cls:"cc-qmd-install-btn mod-cta"}).addEventListener("click",()=>{this.openTerminalWithInstall()});let i=n.createEl("p",{text:"Or run manually:",cls:"cc-qmd-manual-text"});n.createEl("pre").createEl("code",{text:"bun install -g https://github.com/tobi/qmd"}),n.createEl("a",{text:"Learn more about QMD \u2192",href:"https://github.com/tobi/qmd"}).addEventListener("click",d=>{d.preventDefault(),window.open("https://github.com/tobi/qmd","_blank")})}openTerminalWithInstall(){let t="bun install -g https://github.com/tobi/qmd",n=zs.platform();if(n==="darwin"){let r=`
        tell application "Terminal"
          activate
          do script "${t}"
        end tell
      `;(0,Tt.spawn)("osascript",["-e",r],{detached:!0,stdio:"ignore"}).unref(),new X.Notice("Opening Terminal to install QMD...")}else if(n==="win32")(0,Tt.spawn)("cmd",["/c","start","cmd","/k",t],{detached:!0,stdio:"ignore"}).unref(),new X.Notice("Opening terminal to install QMD...");else{let r=["gnome-terminal","konsole","xfce4-terminal","xterm"];for(let i of r)try{i==="gnome-terminal"?(0,Tt.spawn)(i,["--","bash","-c",`${t}; exec bash`],{detached:!0,stdio:"ignore"}).unref():(0,Tt.spawn)(i,["-e",`bash -c "${t}; exec bash"`],{detached:!0,stdio:"ignore"}).unref(),new X.Notice("Opening terminal to install QMD...");return}catch{continue}new X.Notice("Could not open terminal. Please run the command manually.")}this.close()}showIndexPrompt(){if(!this.statusEl)return;this.statusEl.empty(),this.statusEl.addClass("cc-qmd-status-warning");let t=this.statusEl.createDiv();t.createEl("span",{text:"\u26A0\uFE0F Vault not indexed. "}),t.createEl("button",{text:"Index Now",cls:"cc-qmd-index-btn"}).addEventListener("click",async()=>{await this.indexVault()})}async indexVault(){if(this.statusEl){this.statusEl.empty(),this.statusEl.removeClass("cc-qmd-status-warning"),this.statusEl.addClass("cc-qmd-status-indexing"),this.statusEl.textContent="\u23F3 Indexing vault... This may take a few minutes.";try{await this.qmdClient.index(),this.statusEl.textContent="\u2705 Vault indexed successfully!",this.statusEl.removeClass("cc-qmd-status-indexing"),setTimeout(()=>{this.statusEl&&(this.statusEl.textContent="")},3e3)}catch(t){let n=t instanceof Error?t.message:"Unknown error";this.statusEl.textContent=`\u274C Indexing failed: ${n}`,this.statusEl.removeClass("cc-qmd-status-indexing"),this.statusEl.addClass("cc-qmd-status-error")}}}async performSearch(){if(!this.searchInput||!this.resultsContainer||!this.statusEl)return;let t=this.searchInput.value.trim();if(!t){new X.Notice("Please enter a search query");return}this.isSearching=!0,this.statusEl.textContent="\u{1F50D} Searching...",this.resultsContainer.empty();try{this.results=await this.qmdClient.search(t),this.statusEl.textContent=`Found ${this.results.length} results`,this.renderResults()}catch(n){let r=n instanceof Error?n.message:"Unknown error";this.statusEl.textContent=`\u274C Search failed: ${r}`,new X.Notice(`Search failed: ${r}`)}finally{this.isSearching=!1}}renderResults(){if(this.resultsContainer){if(this.resultsContainer.empty(),this.results.length===0){this.resultsContainer.createDiv({text:"No results found. Try a different query.",cls:"cc-qmd-no-results"});return}for(let t of this.results){let n=this.resultsContainer.createDiv({cls:"cc-qmd-result-item"}),r=n.createDiv({cls:"cc-qmd-result-title-row"}),i=r.createEl("span",{text:t.title||t.path,cls:"cc-qmd-result-title"});if(t.score){let o=Math.round(t.score*100);r.createEl("span",{text:`${o}%`,cls:"cc-qmd-result-score"})}t.snippet&&n.createDiv({text:t.snippet.substring(0,200)+(t.snippet.length>200?"...":""),cls:"cc-qmd-result-snippet"}),n.createDiv({text:t.path,cls:"cc-qmd-result-path"}),n.addEventListener("click",()=>{this.openFile(t.path)})}}}async openFile(t){let n=this.app.vault.getAbstractFileByPath(t);n instanceof X.TFile?(await this.app.workspace.getLeaf().openFile(n),this.close()):new X.Notice(`File not found: ${t}`)}onClose(){let{contentEl:t}=this;t.empty()}};var Gs=[{type:"command",command:"summarize",label:"/summarize",description:"Summarize the text above"},{type:"command",command:"expand",label:"/expand",description:"Add more detail and depth"},{type:"command",command:"rewrite",label:"/rewrite",description:"Improve clarity and flow"},{type:"command",command:"fix",label:"/fix",description:"Fix grammar and spelling"},{type:"command",command:"bullets",label:"/bullets",description:"Convert to bullet points"},{type:"command",command:"explain",label:"/explain",description:"Explain in simpler terms"},{type:"command",command:"continue",label:"/continue",description:"Continue writing"},{type:"search",label:"/search",description:"Semantic search vault (QMD)"}],ka={summarize:"Summarize the above text concisely, capturing the key points.",expand:"Expand on the above text with more detail, examples, and depth.",rewrite:"Rewrite the above text to improve clarity, flow, and readability.",fix:"Fix any grammar, spelling, and punctuation errors in the above text.",bullets:"Convert the above text into clear, well-organized bullet points.",explain:"Explain the above text in simpler terms that anyone can understand.",continue:"Continue writing from where the above text left off, maintaining the same style and tone."},Ma={type:"cc",label:"\u{1F4BB} Open in Claude CLI",description:"Launch terminal with full note"},Ra={type:"cc-install",label:"\u{1F4E6} Install Claude CLI",description:"Install and launch Claude CLI"},bn=class extends we.EditorSuggest{constructor(t){super(t.app);this.isExecuting=!1;this.currentTrigger="claude";this.cliInstalled=null;this.plugin=t,this.checkCLIInstalled()}async checkCLIInstalled(){this.cliInstalled=await this.plugin.claudeCLIService.isInstalled()}async handleCCSelection(t,n,r,i){let o=this.plugin.settings.agenticTrigger,l=i.lastIndexOf(o);l!==-1&&n.replaceRange("",{line:r.line,ch:l},{line:r.line,ch:i.length});let d=this.plugin.app.workspace.getActiveFile();if(!d){new we.Notice("No active file");return}let u=await this.plugin.app.vault.read(d),m=d.path;if(t.type==="cc-install"){await this.plugin.claudeCLIService.install(),new we.Notice("After install completes, type @cc again to launch");return}await this.plugin.claudeCLIService.launch(u,m)}onTrigger(t,n,r){if(this.isExecuting)return null;let o=n.getLine(t.line).slice(0,t.ch),l=this.plugin.settings.agenticTrigger,d=o.lastIndexOf(l),u=this.plugin.settings.inlineTrigger,m=o.lastIndexOf(u);return d>m&&this.plugin.settings.agenticEnabled?(this.currentTrigger="cc",{start:{line:t.line,ch:d},end:t,query:o.slice(d+l.length).trim()}):m!==-1&&this.plugin.settings.inlineEnabled?(this.currentTrigger="claude",{start:{line:t.line,ch:m},end:t,query:o.slice(m+u.length).trim()}):null}getSuggestions(t){if(this.currentTrigger==="cc")return this.checkCLIInstalled(),this.cliInstalled===!1?[Ra]:[Ma];let n=t.query.toLowerCase();if(!n)return Gs;let r=Gs.filter(o=>o.command?.startsWith(n)||o.label.toLowerCase().includes(n));if(n.startsWith("/"))return r.length>0?r:[];let i=[...r];return n.length>=3&&i.unshift({type:"custom",label:`\u23CE "${n.slice(0,35)}${n.length>35?"...":""}"`,description:"Run custom prompt",prompt:t.query}),i}renderSuggestion(t,n){let r=n.createDiv({cls:"cc-suggestion"});t.type==="custom"?r.addClass("cc-suggestion-custom"):r.addClass("cc-suggestion-command"),r.createDiv({cls:"cc-suggestion-label"}).setText(t.label),r.createDiv({cls:"cc-suggestion-description"}).setText(t.description)}async selectSuggestion(t,n){let r=this.context?.editor;if(!r||!this.context)return;let i=r.getCursor(),o=r.getLine(i.line);if(t.type==="cc"||t.type==="cc-install"){await this.handleCCSelection(t,r,i,o);return}if(t.type==="search"){let S=this.plugin.settings.inlineTrigger,T=o.lastIndexOf(S);T!==-1&&r.replaceRange("",{line:i.line,ch:T},{line:i.line,ch:o.length}),new Xe(this.plugin.app,this.plugin.qmdClient).open();return}let l=this.plugin.settings.inlineTrigger,d=o.lastIndexOf(l),u;if(t.type==="command"&&t.command)u=ka[t.command]||t.description;else if(t.prompt)u=t.prompt;else{new we.Notice("Please type a prompt after @claude");return}let m="";if(i.line>0){let S=[];for(let T=Math.max(0,i.line-30);T<i.line;T++)S.push(r.getLine(T));m=S.join(`
`)}if(d>0&&(m+=`
`+o.slice(0,d).trim()),!m.trim()){new we.Notice("No text above to work with");return}this.isExecuting=!0;try{let S={line:i.line,ch:d},T={line:i.line,ch:o.length};r.replaceRange("\u258D",S,T);let $=`Here is the text:

${m}

---

${u}

Respond with only the result, no explanations or preamble.`,O=await this.plugin.claudeApi.complete($,void 0,{maxTokens:2048,temperature:.7}),j=r.getLine(i.line).indexOf("\u258D");j!==-1?r.replaceRange(O.trim(),{line:i.line,ch:j},{line:i.line,ch:j+1}):r.replaceRange(`

`+O.trim(),{line:i.line,ch:r.getLine(i.line).length})}catch(S){let T=S instanceof Error?S.message:"Unknown error";new we.Notice(`Error: ${T}`);let O=r.getLine(i.line).indexOf("\u258D");O!==-1&&r.replaceRange(`\u274C ${T}`,{line:i.line,ch:O},{line:i.line,ch:O+1})}finally{this.isExecuting=!1}}};var ie=require("obsidian"),Sn=class extends ie.Modal{constructor(t,n,r=""){super(t);this.questionInput=null;this.responseContainer=null;this.submitBtn=null;this.isLoading=!1;this.claudeApi=n,this.currentContext=r}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("cc-quick-ask-modal"),t.createDiv({cls:"cc-quick-ask-header"}).createEl("h2",{text:"\u{1F4AC} Ask Claude"}),this.currentContext&&t.createDiv({cls:"cc-quick-ask-context"}).createEl("span",{text:"\u{1F4C4} Using current note as context"});let r=t.createDiv({cls:"cc-quick-ask-input-container"});this.questionInput=r.createEl("textarea",{placeholder:"Ask anything...",cls:"cc-quick-ask-input"}),this.questionInput.rows=3,this.questionInput.addEventListener("keydown",o=>{o.key==="Enter"&&(o.metaKey||o.ctrlKey)&&(o.preventDefault(),this.submitQuestion())});let i=t.createDiv({cls:"cc-quick-ask-buttons"});i.createEl("span",{text:"\u2318+Enter to submit",cls:"cc-quick-ask-hint"}),this.submitBtn=i.createEl("button",{text:"Ask",cls:"cc-quick-ask-submit mod-cta"}),this.submitBtn.addEventListener("click",()=>this.submitQuestion()),this.responseContainer=t.createDiv({cls:"cc-quick-ask-response"}),setTimeout(()=>this.questionInput?.focus(),50)}async submitQuestion(){if(!this.questionInput||!this.responseContainer||!this.submitBtn)return;let t=this.questionInput.value.trim();if(!t){new ie.Notice("Please enter a question");return}if(!this.isLoading){this.isLoading=!0,this.submitBtn.disabled=!0,this.submitBtn.textContent="Thinking...",this.responseContainer.empty(),this.responseContainer.addClass("cc-quick-ask-loading"),this.responseContainer.textContent="\u23F3 Claude is thinking...";try{let n=t;this.currentContext&&(n=`Context from current note:

${this.currentContext}

---

Question: ${t}`);let r=await this.claudeApi.complete(n,void 0,{maxTokens:2048,temperature:.7});this.responseContainer.empty(),this.responseContainer.removeClass("cc-quick-ask-loading"),this.responseContainer.addClass("cc-quick-ask-has-response"),await ie.MarkdownRenderer.render(this.app,r,this.responseContainer,"",this),this.responseContainer.createEl("button",{text:"\u{1F4CB} Copy",cls:"cc-quick-ask-copy"}).addEventListener("click",()=>{navigator.clipboard.writeText(r),new ie.Notice("Copied to clipboard")}),this.responseContainer.createEl("button",{text:"\u{1F4DD} Insert",cls:"cc-quick-ask-insert"}).addEventListener("click",()=>{this.insertAtCursor(r)})}catch(n){let r=n instanceof Error?n.message:"Unknown error";this.responseContainer.empty(),this.responseContainer.removeClass("cc-quick-ask-loading"),this.responseContainer.addClass("cc-quick-ask-error"),this.responseContainer.textContent=`\u274C Error: ${r}`,new ie.Notice(`Failed: ${r}`)}finally{this.isLoading=!1,this.submitBtn&&(this.submitBtn.disabled=!1,this.submitBtn.textContent="Ask")}}}insertAtCursor(t){let n=this.app.workspace.activeEditor?.editor;if(n){let r=n.getCursor();n.replaceRange(`

`+t+`
`,r),this.close(),new ie.Notice("Inserted into note")}else new ie.Notice("No active editor")}onClose(){let{contentEl:t}=this;t.empty()}};var Q=require("obsidian"),Y=require("child_process"),Vs=qe(require("fs")),Ks=qe(require("path")),be=qe(require("os")),xn=class{constructor(e){this.app=e}async isInstalled(){return new Promise(e=>{let t=be.platform()==="win32"?"where":"which";(0,Y.execFile)(t,["claude"],n=>{e(!n)})})}async install(){let e="npm install -g @anthropic-ai/claude-code",t=be.platform();if(t==="darwin"){let n=`
        tell application "Terminal"
          activate
          do script "${e}"
        end tell
      `;(0,Y.spawn)("osascript",["-e",n],{detached:!0,stdio:"ignore"}).unref(),new Q.Notice("Opening Terminal to install Claude CLI...")}else if(t==="win32")(0,Y.spawn)("cmd",["/c","start","cmd","/k",e],{detached:!0,stdio:"ignore"}).unref(),new Q.Notice("Opening terminal to install Claude CLI...");else{let n=["gnome-terminal","konsole","xfce4-terminal","xterm"],r=!1;for(let i of n)try{i==="gnome-terminal"?(0,Y.spawn)(i,["--","bash","-c",`${e}; exec bash`],{detached:!0,stdio:"ignore"}).unref():(0,Y.spawn)(i,["-e",`bash -c "${e}; exec bash"`],{detached:!0,stdio:"ignore"}).unref(),r=!0,new Q.Notice("Opening terminal to install Claude CLI...");break}catch{continue}if(!r)return new Q.Notice("Could not open terminal. Run: npm install -g @anthropic-ai/claude-code"),!1}return!0}async launch(e,t){if(!await this.isInstalled()&&(new Q.Notice("Claude CLI not found. Installing..."),!await this.install())){new Q.Notice("Please install manually: npm install -g @anthropic-ai/claude-code");return}let r=be.tmpdir(),i=Ks.join(r,"obsidian-cc-context.md");try{Vs.writeFileSync(i,e,"utf-8")}catch{new Q.Notice("Failed to write context file");return}try{await navigator.clipboard.writeText(e)}catch{}let o=this.app.vault.adapter.basePath||be.homedir(),l=`I'm working with this note from Obsidian (${t}):\\n\\nPlease read the context file at: ${i}`,d=be.platform();if(d==="darwin"){let u=l.replace(/\\/g,"\\\\").replace(/"/g,'\\"'),m=`
        tell application "Terminal"
          activate
          do script "cd '${o.replace(/'/g,"'\\''")}' && claude -p \\"${u}\\""
        end tell
      `;(0,Y.spawn)("osascript",["-e",m],{detached:!0,stdio:"ignore"}).unref(),new Q.Notice("Claude CLI launched with note context")}else if(d==="win32")(0,Y.spawn)("cmd",["/c","start","cmd","/k",`cd /d "${o}" && claude -p "${l}"`],{detached:!0,stdio:"ignore"}).unref(),new Q.Notice("Claude CLI launched with note context");else{let u=["gnome-terminal","konsole","xfce4-terminal","xterm"],m=!1;for(let S of u)try{S==="gnome-terminal"?(0,Y.spawn)(S,["--","bash","-c",`cd '${o}' && claude -p "${l}"; exec bash`],{detached:!0,stdio:"ignore"}).unref():(0,Y.spawn)(S,["-e",`bash -c "cd '${o}' && claude -p \\"${l}\\"; exec bash"`],{detached:!0,stdio:"ignore"}).unref(),m=!0,new Q.Notice("Claude CLI launched with note context");break}catch{continue}m||new Q.Notice("Could not open terminal. Note copied to clipboard. Run: claude")}}};var vr="obsidian-cc-chat",vn=class extends Z.Plugin{async onload(){console.log("Loading Obsidian CC plugin"),await this.loadSettings(),this.keychainService=new It(this),this.sanitizer=new Nt,this.claudeApi=new cn(this.keychainService,{model:this.settings.model,maxTokens:this.settings.maxTokens,temperature:this.settings.temperature}),this.inlineRenderer=new dn(this.claudeApi),this.triggerParser=new pn(this.settings.inlineTrigger,this.settings.agenticTrigger),this.addSettingTab(new un(this.app,this)),this.settings.agenticEnabled&&this.addRibbonIcon("message-circle","Open Claude Chat",()=>{this.activateChatView()}),this.registerCommands(),this.settings.inlineEnabled&&this.registerEditorSuggest(new bn(this)),this.mcpServer=new wn(this.app,this.settings);let e=this.app.vault.adapter.basePath||"";this.qmdClient=new Ke(e,this.settings),this.qmdClient.initialize(),this.claudeCLIService=new xn(this.app),this.settings.mcpServerEnabled&&this.startMCPServer(),console.log("Obsidian CC plugin loaded successfully")}async startMCPServer(){try{await this.mcpServer.start(),this.settings.debugMode&&new Z.Notice(`MCP server started on port ${this.mcpServer.getPort()}`)}catch(e){console.error("Failed to start MCP server:",e),new Z.Notice(`Failed to start MCP server: ${e}`)}}async stopMCPServer(){try{await this.mcpServer.stop(),this.settings.debugMode&&new Z.Notice("MCP server stopped")}catch(e){console.error("Failed to stop MCP server:",e)}}async handleClaudeTriggerPublic(e,t){return this.handleClaudeTrigger(e,t)}async handleClaudeTrigger(e,t){if(!await this.hasApiKey())throw new Z.Notice("Please configure your Anthropic API key in settings"),new Error("API key not configured");this.settings.debugMode&&console.log("Obsidian CC: @claude trigger",{trigger:e,contextLength:t.length});try{let r=await this.inlineRenderer.execute(e,t);return this.settings.auditLogging&&console.log("Obsidian CC: Inline execution completed",{command:e.command,inputTokens:this.claudeApi.estimateTokens(t),outputTokens:this.claudeApi.estimateTokens(r)}),r}catch(r){let i=r instanceof Error?r.message:"Unknown error";throw new Z.Notice(`@claude failed: ${i}`),r}}async handleCCTrigger(e,t){this.settings.debugMode&&console.log("Obsidian CC: @cc trigger",{trigger:e,contextLength:t.length});let r=this.app.workspace.getActiveFile()?.path||"untitled",i=t;e.args&&(i+=`

---
User request: `+e.args),await this.claudeCLIService.launch(i,r)}async onunload(){console.log("Unloading Obsidian CC plugin"),this.mcpServer?.isServerRunning()&&await this.stopMCPServer()}async loadSettings(){this.settings=Object.assign({},Kr,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}registerCommands(){this.addCommand({id:"execute-trigger",name:"Execute @claude/@cc Trigger",hotkeys:[{modifiers:["Mod","Shift"],key:"e"}],editorCallback:e=>{console.log("CC: Command triggered!"),this.executeTriggerOnLine(e)}}),console.log("CC: execute-trigger command registered"),this.addCommand({id:"quick-ask",name:"Quick Ask Claude",hotkeys:[{modifiers:["Mod"],key:"j"}],editorCallback:e=>{let n=e.getSelection()||"";new Sn(this.app,this.claudeApi,n).open()}}),this.addCommand({id:"start-session",name:"Start Chat Session",callback:()=>{this.activateChatView()}}),this.addCommand({id:"search-vault",name:"Semantic Search (QMD)",hotkeys:[{modifiers:["Mod","Shift"],key:"f"}],callback:()=>{new Xe(this.app,this.qmdClient).open()}}),this.addCommand({id:"new-project-github",name:"New Project from GitHub",callback:()=>{console.log("New Project from GitHub command triggered")}}),this.addCommand({id:"analyze-project",name:"Analyze Project",callback:()=>{console.log("Analyze Project command triggered")}})}async activateChatView(){let{workspace:e}=this.app,t=null,n=e.getLeavesOfType(vr);n.length>0?t=n[0]:(t=e.getRightLeaf(!1),t&&await t.setViewState({type:vr,active:!0})),t&&e.revealLeaf(t)}async hasApiKey(){let e=await this.keychainService.getApiKey();return e!==null&&e.length>0}isDebugMode(){return this.settings.debugMode}async executeTriggerOnLine(e){console.log("CC: executeTriggerOnLine called");let t=e.getCursor(),n=e.getLine(t.line);console.log("CC: line:",n);let r=this.triggerParser.parseLine(n);if(console.log("CC: trigger:",r),!r){new Z.Notice("No @claude or @cc trigger found on current line");return}let i=this.triggerParser.validateTrigger(r);if(!i.valid){new Z.Notice(i.error||"Invalid trigger");return}let o="";if(t.line>0){let l=[];for(let d=Math.max(0,t.line-20);d<t.line;d++)l.push(e.getLine(d));o=l.join(`
`)}if(r.type==="claude")try{new Z.Notice("Executing @claude...");let l=await this.handleClaudeTrigger(r,o),d={line:t.line,ch:r.startIndex},u={line:t.line,ch:r.endIndex};e.replaceRange(l,d,u)}catch{}else r.type==="cc"&&this.handleCCTrigger(r,o)}};
/*! Bundled license information:

dompurify/dist/purify.es.mjs:
  (*! @license DOMPurify 3.3.1 | (c) Cure53 and other contributors | Released under the Apache license 2.0 and Mozilla Public License 2.0 | github.com/cure53/DOMPurify/blob/3.3.1/LICENSE *)
*/
